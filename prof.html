<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="stylesheet" href="assets/styles.css?v=8">
<title>Prof • Chrono Vitesse EPS</title>
</head>
<body onload="baseInit()">
<div class="container">
  <div class="header">
    <div class="brand"><img src="assets/icons/logo.svg" alt="">Espace Prof</div>
    <div class="nav">
      <a href="index.html">Accueil</a>
      <a href="aide.html">Aide</a>
      <button onclick="toggleXL()">Taille XL</button>
    </div>
  </div>

  <div class="card">
    <h2>Projection</h2>
    <div class="controls">
      <label>Type de test</label>
      <select id="test">
        <option value="libre">Libre</option>
        <option value="cooper12">Cooper 12'</option>
        <option value="demi6">Demi-Cooper 6'</option>
      </select>
      <label>Longueur du tour (m)</label><input id="tour" type="number" min="10" step="1" value="200">
      <button class="ghost" data-preset="100">100</button>
      <button class="ghost" data-preset="200">200</button>
      <button class="ghost" data-preset="250">250</button>
      <button class="ghost" data-preset="400">400</button>
      <label style="margin-left:12px">Cible VMA (km/h)</label><input id="targetVMA" type="number" min="1" step="0.1">
      <label style="margin-left:12px">Seuils (%, vert/orange)</label><input id="thr2" type="number" min="0.5" step="0.5" value="2"><input id="thr5" type="number" min="1" step="0.5" value="5">
    </div>
    <div class="controls">
      <button class="ghost" id="toggleBeep">Bip</button>
      <button class="ghost" id="toggleVib">Vibration</button>
      <button class="ghost" id="toggleFS">Plein écran</button>
      <button class="ghost" id="toggleWake">Anti-veille</button>
      <button class="primary" id="btnCountdown">Compte à rebours 10s</button>
    </div>

    <div class="timer zone" id="zone">
      <div class="timer-screen" id="screen">00:00</div>
      <div class="timer-sub" id="live">Prêt</div>
      <div class="timer-bar"><div id="bar"></div></div>
      <div class="timer-actions">
        <button class="btn-start" id="btnStart">Démarrer</button>
        <button class="btn-lap" id="btnLap" disabled>Intermédiaire</button>
        <button class="btn-stop" id="btnStop" disabled>Stop</button>
        <button class="btn-reset" id="btnReset" disabled>Réinitialiser</button>
      </div>
      <table class="table"><thead><tr><th>#</th><th>Passage</th><th>Temps</th><th>Cumulé</th></tr></thead><tbody id="tbody"></tbody></table>
    </div>
  </div>

  <div class="card">
    <h2>Classe (VMA)</h2>
    <div class="controls">
      <input id="nom" placeholder="Nom">
      <input id="prenom" placeholder="Prénom">
      <input id="classe" placeholder="2A, 3C...">
      <select id="sexe"><option value="">sexe</option><option value="F">fille</option><option value="M">garcon</option><option value="X">autre</option></select>
      <button id="add" class="ghost">Ajouter</button>
      <button id="clear" class="ghost">Vider</button>
      <button id="export" class="primary">Exporter CSV</button>
      <button id="print" class="ghost" onclick="window.print()">Exporter PDF</button>
      <select id="tri">
        <option value="alpha">Tri: A→Z</option>
        <option value="vma_asc">Tri: VMA ↑</option>
        <option value="vma_desc">Tri: VMA ↓</option>
      </select>
      <button id="assign" class="ghost" title="Assigner la VMA du dernier test au sélectionné">Assigner VMA ← test</button>
    </div>
    <table class="table" id="roster"><thead><tr><th>#</th><th>Nom</th><th>Prénom</th><th>Classe</th><th>Sexe</th><th>VMA</th><th>Sélection</th></tr></thead><tbody></tbody></table>
  </div>

  <div class="footer">© EPS • PRO v8</div>
</div>
<script src="assets/app.js?v=8"></script>
<script>
// Persist some fields
['test','tour','targetVMA','thr2','thr5'].forEach(id=>{ const el=document.getElementById(id); const v=localStorage.getItem('prof_'+id); if(v!==null) el.value=v; el.addEventListener('input',()=>localStorage.setItem('prof_'+id, el.value)); });

// Toggles
let wl=null; toggleBeep.onclick=()=>useBeep=!useBeep; toggleVib.onclick=()=>useVib=!useVib;
toggleFS.onclick=()=>{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } else { document.exitFullscreen?.(); } };
toggleWake.onclick=async()=>{ try{ wl = wl || (navigator.wakeLock && await navigator.wakeLock.request('screen')); }catch(e){ alert("Anti-veille non supporté"); } };

// Timer
const timer=new DigitalTimer({screen:screen, sub:null, bar:bar});
const tbody=document.getElementById('tbody');
let nextLabel=0;
function getTour(){ return Math.max(10, parseInt(tour.value||'200',10)); }
function tgtV(){ const t=parseFloat(targetVMA.value||''); return isFinite(t)&&t>0? t:null; }
function thr(){ const t2=parseFloat(thr2.value||'2'), t5=parseFloat(thr5.value||'5'); return {t2:Math.max(0.5,t2)/100, t5:Math.max(1,t5)/100}; }
function setZone(color){ zone.classList.remove('green','orange','red'); if(color) zone.classList.add(color); }
document.querySelectorAll('[data-preset]').forEach(b=> b.onclick=()=>{ tour.value=b.getAttribute('data-preset'); nextLabel=getTour(); });

function applyPreset(){ const t=test.value; if(t==='cooper12'){ timer.setTargetMinutes(12); live.textContent="Test Cooper 12 minutes"; } else if(t==='demi6'){ timer.setTargetMinutes(6); live.textContent="Demi-Cooper 6 minutes"; } else { timer.setTargetMinutes(null); live.textContent="Mode Libre"; } }
applyPreset(); test.onchange=applyPreset;

btnStart.onclick=()=>{ timer.start(); btnLap.disabled=false; btnStop.disabled=false; btnReset.disabled=false; };
btnLap.onclick=()=>{ timer.lap(); vibrate(60); beep(); };
btnStop.onclick=()=>timer.stop();
btnReset.onclick=()=>{ timer.reset(); tbody.innerHTML=''; live.textContent='Prêt'; nextLabel=getTour(); setZone(null); };

document.addEventListener('timer:lap', ({detail:{idx,lapMs,cumMs}})=>{
  const tr=document.createElement('tr');
  if(nextLabel===0) nextLabel=getTour();
  const label=`${nextLabel} m`; nextLabel+=getTour();
  tr.innerHTML=`<td>${idx}</td><td>${label}</td><td>${fmt(lapMs)}</td><td>${fmt(cumMs)}</td>`;
  tbody.appendChild(tr);
});
function fmt(ms){ const m=Math.floor(ms/60000), s=Math.floor((ms%60000)/1000); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`; }

function updateLive(){
  const splits=timer.getSplits(); const dist=splits.length*getTour(); const sec=timer.getTotal()/1000;
  const vInst=splits.length?(getTour()/(splits[splits.length-1].lapMs/1000))*3.6:0;
  const vma=sec>0?(dist/sec)*3.6:0;
  const tgt=tgtV();
  live.textContent=`Dist ${dist} m • Vitesse ${vInst.toFixed(2)} km/h • VMA ${vma.toFixed(2)} km/h`+(tgt?` • Cible ${tgt} km/h`:'');
  if(tgt){ const {t2,t5}=thr(); const dev=Math.abs(vInst-tgt)/tgt; setZone(dev<=t2 ? 'green' : (dev<=t5 ? 'orange' : 'red')); }
  requestAnimationFrame(updateLive);
}
updateLive();

btnCountdown.onclick=async()=>{
  if(document.fullscreenEnabled && !document.fullscreenElement){ await document.documentElement.requestFullscreen().catch(()=>{}); }
  let count=10; live.textContent="Départ dans 10"; const id=setInterval(()=>{
    count--; live.textContent = count>0? `Départ dans ${count}` : "GO !";
    if(count<=0){ clearInterval(id); beep(880,160); vibrate(120); timer.start(); btnLap.disabled=false; btnStop.disabled=false; btnReset.disabled=false; }
  },1000);
};

// Roster logic
const rosterBody=document.querySelector('#roster tbody');
function renderRoster(){
  let list = Roster.load();
  const sort = tri.value;
  if(sort==='alpha'){ list = list.sort((a,b)=>(a.nom+a.prenom).localeCompare(b.nom+b.prenom)); }
  if(sort==='vma_asc'){ list = list.sort((a,b)=>(a.vma??1e9)-(b.vma??1e9)); }
  if(sort==='vma_desc'){ list = list.sort((a,b)=>(b.vma??-1)-(a.vma??-1)); }
  rosterBody.innerHTML='';
  list.forEach((s,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`<td>${i+1}</td><td>${s.nom}</td><td>${s.prenom}</td><td>${s.classe}</td><td>${s.sexe||''}</td><td>${s.vma??''}</td><td><input type="radio" name="sel" value="${i}"></td>`;
    rosterBody.appendChild(tr);
  });
}
renderRoster();
add.onclick=()=>{ if(!nom.value||!prenom.value||!classe.value){alert('Nom, Prénom, Classe requis');return;} Roster.add(nom.value.trim(),prenom.value.trim(),classe.value.trim(),sexe.value); nom.value=prenom.value=classe.value=''; sexe.value=''; renderRoster(); };
clear.onclick=()=>{ if(confirm('Supprimer toute la liste ?')){ Roster.clear(); renderRoster(); } };
export.onclick=()=>{ download('classe_vma.csv', csvFromRoster(Roster.load()), 'text/csv;charset=utf-8'); };
assign.onclick=()=>{
  const radio=document.querySelector('input[name=sel]:checked'); if(!radio){ alert('Sélectionner un élève'); return; }
  const splits=timer.getSplits(); const d=splits.length*getTour(); const sec=timer.getTotal()/1000; const vma=sec>0?(d/sec)*3.6:0;
  Roster.setVMA(+radio.value, +vma.toFixed(2)); renderRoster();
};
tri.onchange=renderRoster;
</script>
</body></html>
