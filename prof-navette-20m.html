<!DOCTYPE html><html lang="fr"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
<title>Navette 20 m ‚Äî Prof</title><link rel="stylesheet" href="styles.css"></head>
<body><div class="container" id="root">
<header><h1>üéµ Navette 20 m ‚Äî Classe enti√®re</h1><div class="actions"><a class="btn" href="prof.html">üë• Classe</a><button class="btn" id="fs">‚õ∂ Plein √©cran</button></div></header>

<div class="grid">
  <section class="card"><div class="content">
    <div class="grid-3">
      <div><label>D√©part (km/h)</label><input id="start" class="input" type="number" value="8.5" step="0.5" min="6" max="12"></div>
      <div><label>Incr√©ment (+km/h/min)</label><input id="inc" class="input" type="number" value="0.5" step="0.5" min="0.5" max="1"></div>
      <div><label>Balise (m)</label><input id="balise" class="input" type="number" value="20"></div>
    </div>
    <div class="toolbar" style="margin-top:8px">
      <button class="btn ok" id="startBtn">‚ñ∂Ô∏è Start</button>
      <button class="btn warn" id="pauseBtn">‚è∏ Pause</button>
      <button class="btn danger" id="resetBtn">‚ü≤ Reset</button>
      <span class="pill">Bip court : 20 m ‚Ä¢ Bip long : changement de palier</span>
    </div>
  </div></section>

  <section class="card"><div class="content stage">
    <div class="timer" id="circle"><div class="center">
      <div class="time" id="speed">8.5</div>
      <div class="hint">km/h ‚Äî Palier <span id="palier">1</span></div>
    </div></div>
    <div style="flex:1">
      <div class="progressBar"><div class="progressInner" id="bar"></div></div>
      <div class="help" id="status">Pr√™t</div>
      <div class="sep"></div>
      <div class="keytips">‚éµ Espace = Start/Pause ‚Ä¢ ‚õ∂ Plein √©cran conseill√©</div>
    </div>
  </div></section>
</div>

<div class="card"><div class="content">
  <h2>√âl√®ves (cliquez pour enregistrer la VMA)</h2>
  <div id="roster"></div>
  <div class="actions" style="margin-top:10px"><button class="btn primary" id="exportCSV">‚¨áÔ∏è Export CSV</button></div>
</div></div>

<div class="modal" id="modal">
  <div class="box">
    <header><div id="mTitle">Saisie</div><button class="btn" id="mClose">‚úñ</button></header>
    <div class="content">
      <div class="grid-2">
        <div><label>VMA (km/h)</label><input class="input" id="mVma"></div>
        <div><label>Observateur(s) (optionnel)</label><input class="input" id="mObs" placeholder="nom(s)"></div>
      </div>
      <div class="actions" style="margin-top:12px"><button class="btn ok" id="mSave">Enregistrer</button><button class="btn" id="mQR">QR √©l√®ve</button></div>
      <div class="center" style="margin-top:10px"><div id="mQRBox"></div></div>
    </div>
  </div>
</div>

</div><div class="footer">ChronoVitesse - Equipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</div>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script>
const $ = (id)=>document.getElementById(id);
let ctx,gain; function audioInit(){ if(ctx) return; ctx=new (window.AudioContext||window.webkitAudioContext)(); gain=ctx.createGain(); gain.gain.value=0.8; gain.connect(ctx.destination); }
function beep(freq=880, dur=0.1){ if(!ctx) audioInit(); const o=ctx.createOscillator(); o.frequency.value=freq; const g=ctx.createGain(); g.gain.value=0.8; o.connect(g).connect(ctx.destination); o.start(); setTimeout(()=>o.stop(), dur*1000); }
function kmh_to_mps(v){ return v*1000/3600; }

let running=false; let palier=1; let speed=8.5; let minuteIv=null, lapIv=null, raf=null; let circleStart=0;
function lapSeconds(){ const m = Number(document.getElementById('balise').value||20); return m / kmh_to_mps(speed); }
function setCircle(pct){ const deg=Math.max(0,Math.min(100,pct))*3.6; document.getElementById('circle').style.background=`conic-gradient(var(--accent) ${deg}deg, #1f2937 ${deg}deg)`; }
function tick(){ if(!running) return; const now=performance.now(); const pct = ((now-circleStart)%60000)/600; setCircle(pct); const ls=lapSeconds()*1000; const p=((now-circleStart)%ls)/ls*100; document.getElementById('bar').style.width=p+'%'; raf=requestAnimationFrame(tick); }
function schedule(){ minuteIv=setInterval(()=>{ palier+=1; speed+=Number(document.getElementById('inc').value||0.5); beep(1200,0.2); circleStart=performance.now(); document.getElementById('speed').textContent=speed.toFixed(1); document.getElementById('palier').textContent=palier; document.getElementById('status').textContent='Palier '+palier+' ‚Äî '+speed.toFixed(1)+' km/h'; },60000);
  function setLap(){ const iv=lapSeconds()*1000; lapIv=setInterval(()=>beep(800,0.06),iv); } setLap(); const res=setInterval(()=>{ if(!running){ clearInterval(res); return; } clearInterval(lapIv); setLap(); },60000); }
function startRun(){ audioInit(); if(running) return; running=true; palier=1; speed=Number(document.getElementById('start').value||8.5); document.getElementById('speed').textContent=speed.toFixed(1); document.getElementById('palier').textContent=palier; circleStart=performance.now(); schedule(); tick(); document.getElementById('status').textContent='En cours'; }
document.getElementById('startBtn').onclick=startRun; document.getElementById('pauseBtn').onclick=()=>{ if(!running) return; running=false; clearInterval(minuteIv); clearInterval(lapIv); cancelAnimationFrame(raf); document.getElementById('status').textContent='Pause'; };
document.getElementById('resetBtn').onclick=()=>{ running=false; clearInterval(minuteIv); clearInterval(lapIv); cancelAnimationFrame(raf); setCircle(0); document.getElementById('bar').style.width='0%'; document.getElementById('status').textContent='Pr√™t'; };
document.addEventListener('keydown',(e)=>{ if(e.code==='Space'){ e.preventDefault(); if(running){ document.getElementById('pauseBtn').click(); } else { document.getElementById('startBtn').click(); } } });
document.getElementById('fs').onclick=async()=>{ const el=document.getElementById('root'); if(document.fullscreenElement) await document.exitFullscreen(); else await el.requestFullscreen().catch(()=>{}); };

// Roster + capture
const roster = JSON.parse(localStorage.getItem('cv_roster')||'[]'); let results=[];
function renderRoster(){ const box=document.getElementById('roster'); box.innerHTML=''; if(roster.length===0){ box.innerHTML='<p class="help">Aucun √©l√®ve. Retournez dans Espace Prof &gt; Classe.</p>'; return; }
  roster.forEach((s,idx)=>{ const r=results.find(x=>x.idx===idx); const vtxt=r? (r.vma.toFixed(1)+' km/h') : '<span class="help">En cours‚Ä¶</span>';
    const row=document.createElement('div'); row.className='row'+(r?' done':'');
    row.innerHTML=`<div class="name">${s.nom} ${s.prenom}</div><div class="pill">${s.classe}</div><div class="tag">${s.sexe}</div><div class="tag">${s.obs?'observateur':'coureur'}</div><div>${vtxt}</div>`;
    row.onclick=()=>openModal(idx, s); box.appendChild(row);
  });
}
renderRoster();

const modal=document.getElementById('modal'), mTitle=document.getElementById('mTitle'), mVma=document.getElementById('mVma'), mObs=document.getElementById('mObs'), mQRBox=document.getElementById('mQRBox');
document.getElementById('mClose').onclick=()=>{ modal.style.display='none'; mQRBox.innerHTML=''; };
function openModal(idx,s){ mTitle.textContent=s.nom+' '+s.prenom+' ‚Äî '+speed.toFixed(1)+' km/h'; mVma.value=speed.toFixed(1); mObs.value=''; mQRBox.innerHTML=''; modal.style.display='flex';
  document.getElementById('mSave').onclick=()=>{ const v=Number(mVma.value||speed); const ex=results.find(r=>r.idx===idx);
    if(ex){ ex.vma=v; ex.observateurs=mObs.value; } else { results.push({idx, nom:s.nom, prenom:s.prenom, classe:s.classe, sexe:s.sexe, vma:v, test:'Navette20m', observateurs:mObs.value}); }
    modal.style.display='none'; renderRoster();
  };
  document.getElementById('mQR').onclick=()=>{ mQRBox.innerHTML=''; const payload=[{nom:s.nom, prenom:s.prenom, classe:s.classe, sexe:s.sexe, distance:0, vitesse:Number((mVma.value||speed).toFixed(1)), vma:Number((mVma.value||speed).toFixed(1))}]; const div=document.createElement('div'); div.id='tmpQR'; mQRBox.appendChild(div); new QRCode(div, {text:JSON.stringify(payload), width:220, height:220}); };
}

// Export CSV
document.getElementById('exportCSV').onclick=()=>{ const full=roster.map((s,idx)=>{ const r=results.find(x=>x.idx===idx); const v=r? r.vma : speed; const obs=r? (r.observateurs||'') : ''; return {nom:s.nom,prenom:s.prenom,classe:s.classe,sexe:s.sexe,test:'Navette20m',vitesse:v.toFixed(1),vma:v.toFixed(1),observateurs:obs}; });
  const head='nom,prenom,classe,sexe,test,vitesse,vma,observateurs\n'; const rows=full.map(o=>[o.nom,o.prenom,o.classe,o.sexe,o.test,o.vitesse,o.vma,o.observateurs].join(',')).join('\n'); const blob=new Blob([head+rows], {type:'text/csv'}); const a=document.createElement('a'); a.href=URL.createObjectURL(blob); a.download='resultats_navette20m.csv'; a.click(); URL.revokeObjectURL(a.href);
};
</script></body></html>