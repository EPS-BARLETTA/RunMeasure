<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChronoVitesse</title>
  <style>
    :root{
      --bg:#f6f7fb; --fg:#111; --muted:#6b7280;
      --primary:#0ea5e9; --success:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --card:#ffffff; --ring:#e5e7eb; --accent:#8b5cf6;
      --track:#e5e7eb; --progress:#0ea5e9;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg); background:var(--bg); display:flex; flex-direction:column;
    }
    footer{
      margin-top:auto; padding:14px 16px; text-align:center; font-size:.92rem;
      background:#fff; border-top:1px solid var(--ring);
    }
    .container{max-width:960px; margin:0 auto; padding:16px}
    .brand{font-size:clamp(36px,6vw,64px); font-weight:800; letter-spacing:.5px; margin:16px 0 8px}
    .sub{color:var(--muted); margin-bottom:24px}
    .card{
      background:var(--card); border:1px solid var(--ring); border-radius:18px;
      padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.04);
    }
    .center{display:flex; justify-content:center; align-items:center; text-align:center}
    .stack{display:flex; flex-direction:column; gap:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .grid-2{display:grid; grid-template-columns:1fr; gap:14px}
    @media(min-width:780px){ .grid-2{grid-template-columns:1fr 1fr} }
    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      padding:12px 18px; border-radius:14px; background:var(--primary); color:#fff; font-size:1rem;
      box-shadow:0 6px 16px rgba(14,165,233,.25); transition:transform .05s ease;
    }
    .btn.sec{background:#e5e7eb; color:#111; box-shadow:none}
    .btn.help{background:var(--accent)}
    .btn.warn{background:var(--warn)}
    .btn.success{background:var(--success)}
    .btn.danger{background:var(--danger)}
    .btn.circle{width:96px; height:96px; border-radius:999px; font-size:.95rem; display:flex; align-items:center; justify-content:center}
    label{font-weight:600; font-size:.95rem}
    input,select{width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring); background:#fff; font-size:1rem}
    table{width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--ring); background:#fff}
    th,td{padding:10px 12px; border-bottom:1px solid var(--ring); font-size:.96rem}
    th{background:#f3f4f6; text-align:left}
    tr:nth-child(even) td{background:#fafafa}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:.85rem}
    .muted{color:var(--muted)}
    .section{display:none}
    .section.active{display:block}
    .qrbox{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    #qrcode canvas{border-radius:8px; border:1px solid var(--ring)}
    .foot-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}

    /* Chronos ronds */
    .dial-wrap{position:relative; width:280px; height:280px}
    .dial{width:280px; height:280px; display:block; transform:rotate(-90deg)}
    .dial-track{stroke:#e5e7eb; stroke-width:16; fill:none}
    .dial-progress{stroke:var(--progress); stroke-width:16; fill:none; stroke-linecap:round; transition:stroke-dashoffset .15s ease}
    .dial-center{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px}
    .dial-time{font-variant-numeric:tabular-nums; font-size:44px; font-weight:900; letter-spacing:.5px; color:#0b4975}
    .dial-meta{font-size:.9rem; color:var(--muted)}
    .alert .dial-progress{stroke:var(--danger)}
    .alert .dial-time{color:#7f1d1d}
  </style>
  <!-- QRCode.js fiable (CDN) -->
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>

  <!-- ACCUEIL -->
  <main id="view-home" class="section active">
    <div class="container center">
      <div class="stack" style="width:100%;max-width:720px">
        <div class="brand">ChronoVitesse</div>
        <div class="sub">Choisis ton mode : minuteur, chrono simple, ou chrono avec tours (QR ScanProf).</div>
        <div class="card center">
          <div class="stack">
            <button class="btn help" id="btn-go-modes">Choisir un mode</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- MODES -->
  <section id="view-modes" class="section">
    <div class="container">
      <h2 class="brand" style="font-size:32px">Modes de chrono</h2>
      <div class="grid-2">
        <div class="card stack">
          <h3>Minuteur</h3>
          <p>Définis un temps (mm:ss) et lance un décompte sur grand cadran.</p>
          <button class="btn" id="mode-timer">Ouvrir le minuteur</button>
        </div>
        <div class="card stack">
          <h3>Chrono simple</h3>
          <p>Comptage du temps écoulé sur grand cadran. Start / Pause / Réinit.</p>
          <button class="btn" id="mode-simple">Ouvrir le chrono simple</button>
        </div>
        <div class="card stack" style="grid-column:1/-1">
          <h3>Chrono avec tours</h3>
          <p>Pour l’EPS : élève, distance totale & par tour, vitesses instantanées, tableau des tours, <b>QR ScanProf</b> et CSV.</p>
          <div class="row">
            <button class="btn help" id="mode-laps">Ouvrir (passe par l’Aide)</button>
            <button class="btn sec" onclick="go('view-home')">Retour</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- AIDE (pour mode Tours) -->
  <section id="view-help" class="section">
    <div class="container">
      <h2 class="brand" style="font-size:32px">Mode d’emploi — Chrono avec tours</h2>
      <div class="card">
        <div class="grid-2">
          <div class="stack">
            <h3>1) Saisie élève</h3>
            <p>Entre <b>Nom / Prénom / Classe / Sexe</b>, choisis la <b>distance totale</b> (ex. 800 m) et la <b>distance par tour</b> (ex. 200 m).</p>
            <h3>2) Lancer la course</h3>
            <p><span class="pill">Démarrer</span> puis <span class="pill">Tour</span> à chaque passage. Mode des tours : <i>Temps du tour</i> ou <i>Temps cumulé</i>.</p>
          </div>
          <div class="stack">
            <h3>3) Fin & exports</h3>
            <p>À l’arrêt : tableau des tours, <b>QR</b> (ScanProf) et <b>CSV</b>. <b>Réinitialiser</b> pour une nouvelle course.</p>
            <p class="muted">Vitesse instantanée = distance du tour / temps du tour (km/h). VMA estimée = vitesse moyenne.</p>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn sec" onclick="go('view-modes')">Retour</button>
          <button class="btn success" id="btn-help-continue">Commencer</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SAISIE ÉLÈVE (Tours) -->
  <section id="view-form" class="section">
    <div class="container">
      <h2 class="brand" style="font-size:32px">Saisie élève</h2>
      <div class="card">
        <div class="grid-2">
          <div class="stack"><label>Nom</label><input id="in-nom" placeholder="Martin" /></div>
          <div class="stack"><label>Prénom</label><input id="in-prenom" placeholder="Julie" /></div>
          <div class="stack"><label>Classe</label><input id="in-classe" placeholder="4C" /></div>
          <div class="stack">
            <label>Sexe</label>
            <select id="in-sexe">
              <option value="M">Garçon (M)</option>
              <option value="F">Fille (F)</option>
              <option value="Autre">Autre</option>
            </select>
          </div>
          <div class="stack"><label>Distance totale (m)</label><input id="in-total" type="number" inputmode="numeric" value="800"/></div>
          <div class="stack"><label>Distance par tour (m)</label><input id="in-lap" type="number" inputmode="numeric" value="200"/></div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn sec" onclick="go('view-help')">Retour</button>
          <button class="btn" id="btn-to-race">Aller au chrono</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CHRONO AVEC TOURS -->
  <section id="view-race" class="section">
    <div class="container">
      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:10px">
        <div>
          <div class="brand" style="font-size:28px; margin:0">Chrono (Tours)</div>
          <div class="muted" id="race-student"></div>
        </div>
        <div>
          <label style="font-weight:700">Mode des tours</label>
          <select id="mode-tours">
            <option value="lap">Temps du tour</option>
            <option value="cum">Temps cumulé</option>
          </select>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="center" style="flex-direction:column; gap:14px">
          <!-- Cadran rond -->
          <div class="dial-wrap" id="dial-wrap-laps">
            <svg class="dial" viewBox="0 0 220 220">
              <circle class="dial-track" cx="110" cy="110" r="90"></circle>
              <circle class="dial-progress" id="dial-progress-laps" cx="110" cy="110" r="90"></circle>
            </svg>
            <div class="dial-center">
              <div id="timer-laps" class="dial-time">00:00.0</div>
              <div class="dial-meta"><span id="meta-done">0</span>/<span id="meta-total">—</span> m</div>
            </div>
          </div>

          <div class="row">
            <button id="btn-start-race" class="btn circle">Démarrer</button>
            <button id="btn-lap" class="btn circle success">Tour</button>
            <button id="btn-stop" class="btn circle warn">Stop</button>
            <button id="btn-reset" class="btn circle danger">Réinit.</button>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div class="card">
          <h3 style="margin-top:0">Tableau des tours</h3>
          <table>
            <thead><tr><th>#</th><th>Distance (m)</th><th>Temps tour</th><th>Temps cumulé</th><th>Vitesse inst. (km/h)</th></tr></thead>
            <tbody id="laps-body"></tbody>
          </table>
          <div class="row foot-actions" style="margin-top:12px">
            <button class="btn sec" onclick="go('view-form')">Changer élève</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Résultats</h3>
          <div class="stack">
            <div><b>Distance totale visée :</b> <span id="out-total">—</span> m</div>
            <div><b>Distance effectuée :</b> <span id="out-done">0</span> m</div>
            <div><b>Temps total :</b> <span id="out-time">00:00.0</span></div>
            <div><b>Vitesse moyenne :</b> <span id="out-avg">0.00</span> km/h</div>
            <div><b>VMA estimée :</b> <span id="out-vma">0.00</span> km/h</div>
          </div>

          <hr style="border:none;border-top:1px solid var(--ring); margin:14px 0">

          <h4>QR compatible ScanProf</h4>
          <div class="qrbox">
            <div id="qrcode"></div>
            <div class="stack" style="min-width:240px">
              <button id="btn-generate-qr" class="btn">Générer le QR</button>
              <button id="btn-download-csv" class="btn warn">Exporter CSV</button>
              <button id="btn-new" class="btn sec">Nouvelle course</button>
            </div>
          </div>
          <p class="muted" style="margin-top:8px">QR = [ { nom, prenom, classe, sexe, distance, vitesse, vma, laps[] } ]</p>
        </div>
      </div>
    </div>
  </section>

  <!-- MINUTEUR -->
  <section id="view-timer" class="section">
    <div class="container">
      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:10px">
        <div class="brand" style="font-size:28px; margin:0">Minuteur</div>
        <button class="btn sec" onclick="go('view-modes')">Retour modes</button>
      </div>

      <div class="card center" style="flex-direction:column; gap:14px; margin-top:12px">
        <div class="row">
          <div class="stack"><label>Minutes</label><input id="tm-min" type="number" min="0" value="3"></div>
          <div class="stack"><label>Secondes</label><input id="tm-sec" type="number" min="0" max="59" value="0"></div>
        </div>

        <div class="dial-wrap" id="dial-wrap-timer">
          <svg class="dial" viewBox="0 0 220 220">
            <circle class="dial-track" cx="110" cy="110" r="90"></circle>
            <circle class="dial-progress" id="dial-progress-timer" cx="110" cy="110" r="90"></circle>
          </svg>
          <div class="dial-center">
            <div id="timer-down" class="dial-time">03:00.0</div>
            <div class="dial-meta">Décompte</div>
          </div>
        </div>

        <div class="row">
          <button id="tm-start" class="btn circle">Démarrer</button>
          <button id="tm-pause" class="btn circle warn">Pause</button>
          <button id="tm-reset" class="btn circle danger">Réinit.</button>
        </div>
      </div>
    </div>
  </section>

  <!-- CHRONO SIMPLE -->
  <section id="view-simple" class="section">
    <div class="container">
      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:10px">
        <div class="brand" style="font-size:28px; margin:0">Chrono simple</div>
        <button class="btn sec" onclick="go('view-modes')">Retour modes</button>
      </div>

      <div class="card center" style="flex-direction:column; gap:14px; margin-top:12px">
        <div class="dial-wrap" id="dial-wrap-simple">
          <svg class="dial" viewBox="0 0 220 220">
            <circle class="dial-track" cx="110" cy="110" r="90"></circle>
            <circle class="dial-progress" id="dial-progress-simple" cx="110" cy="110" r="90"></circle>
          </svg>
          <div class="dial-center">
            <div id="timer-up" class="dial-time">00:00.0</div>
            <div class="dial-meta">Comptage</div>
          </div>
        </div>

        <div class="row">
          <button id="sp-start" class="btn circle">Démarrer</button>
          <button id="sp-pause" class="btn circle warn">Pause</button>
          <button id="sp-reset" class="btn circle danger">Réinit.</button>
        </div>
      </div>
    </div>
  </section>

  <footer>
    ChronoVitesse - Equipe EPS Lycée Vauban - LUXEMBOURG - JB
  </footer>

  <script>
    // ===== helpers =====
    const byId = (id)=>document.getElementById(id);
    const go = (id)=>{ document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); byId(id).classList.add('active'); };
    const fmt = (ms)=>{ const t=Math.floor(ms/100)/10, m=Math.floor(t/60), s=Math.floor(t%60), d=Math.floor((t*10)%10); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`; };
    const kmh = (meters, seconds)=> seconds>0 ? (meters/seconds)*3.6 : 0;

    // ===== routing =====
    byId('btn-go-modes').onclick = ()=> go('view-modes');
    byId('mode-timer').onclick  = ()=> go('view-timer');
    byId('mode-simple').onclick = ()=> go('view-simple');
    byId('mode-laps').onclick   = ()=> go('view-help');
    byId('btn-help-continue').onclick = ()=> go('view-form');

    // ===== circular progress util =====
    function applyDialProgress(circleElem, wrapElem, ratio, alert=false){
      const r = parseFloat(circleElem.getAttribute('r'));
      const C = 2*Math.PI*r;
      circleElem.style.strokeDasharray = `${C} ${C}`;
      circleElem.style.strokeDashoffset = String(C*(1-Math.max(0, Math.min(1, ratio))));
      wrapElem.classList.toggle('alert', alert);
    }

    /* =========================
       MODE "CHRONO AVEC TOURS"
    ==========================*/
    const lapsState = {
      student:{nom:'',prenom:'',classe:'',sexe:'M'},
      total:800, lap:200,
      running:false, startAt:0, tickId:null, lastLapAt:0,
      laps:[], // {i, dist, lapMs, cumMs, vInst}
      mode:'lap' // 'lap' or 'cum'
    };

    // Saisie -> Chrono
    byId('btn-to-race').onclick = ()=>{
      lapsState.student.nom = byId('in-nom').value.trim();
      lapsState.student.prenom = byId('in-prenom').value.trim();
      lapsState.student.classe = byId('in-classe').value.trim();
      lapsState.student.sexe = byId('in-sexe').value || 'M';
      lapsState.total = Math.max(0, +byId('in-total').value||0);
      lapsState.lap = Math.max(1, +byId('in-lap').value||1);
      lapsState.mode = byId('mode-tours').value = 'lap';

      if(!lapsState.student.nom || !lapsState.student.prenom || !lapsState.student.classe){
        alert('Merci de renseigner Nom, Prénom et Classe.');
        return;
      }
      byId('race-student').textContent = `${lapsState.student.prenom} ${lapsState.student.nom} — ${lapsState.student.classe} — ${lapsState.student.sexe}`;
      byId('out-total').textContent = lapsState.total;
      byId('out-done').textContent = '0';
      byId('out-time').textContent = '00:00.0';
      byId('out-avg').textContent = '0.00';
      byId('out-vma').textContent = '0.00';
      byId('laps-body').innerHTML = '';
      byId('qrcode').innerHTML='';
      lapsState.laps=[]; lapsState.running=false; lapsState.startAt=0; lapsState.lastLapAt=0; clearInterval(lapsState.tickId); lapsState.tickId=null;
      byId('timer-laps').textContent='00:00.0';
      applyDialProgress(byId('dial-progress-laps'), byId('dial-wrap-laps'), 0, false);
      byId('meta-total').textContent = String(lapsState.total);
      byId('meta-done').textContent = '0';
      go('view-race');
    };

    byId('mode-tours').onchange = (e)=>{ lapsState.mode = e.target.value; };

    const totalElapsedMs = ()=> lapsState.laps.length ? lapsState.laps[lapsState.laps.length-1].cumMs : (lapsState.running ? (performance.now()-lapsState.startAt) : 0);
    const doneMeters = ()=> lapsState.laps.length * lapsState.lap;

    function updateLapsUI(){
      const elapsed = performance.now() - lapsState.startAt;
      byId('timer-laps').textContent = fmt(elapsed);
      byId('out-time').textContent = fmt(totalElapsedMs());
      const avg = kmh(doneMeters(), totalElapsedMs()/1000);
      byId('out-avg').textContent = avg.toFixed(2);
      byId('out-vma').textContent = avg.toFixed(2);
      const ratio = lapsState.total>0 ? doneMeters()/lapsState.total : 0;
      const alert = (Math.floor((elapsed/1000)%60) >= 50);
      applyDialProgress(byId('dial-progress-laps'), byId('dial-wrap-laps'), ratio, alert);
    }

    byId('btn-start-race').onclick = ()=>{
      if(lapsState.running) return;
      lapsState.running=true;
      const now = performance.now();
      lapsState.startAt = now;
      lapsState.lastLapAt = now;
      lapsState.tickId = setInterval(updateLapsUI, 100);
    };

    function stopLaps(){
      if(!lapsState.running) return;
      lapsState.running=false;
      clearInterval(lapsState.tickId); lapsState.tickId=null;
      updateLapsUI();
    }
    byId('btn-stop').onclick = stopLaps;

    function pushLap(lapMs, cumMs){
      const i = lapsState.laps.length+1;
      const dist = i*lapsState.lap;
      const vInst = kmh(lapsState.lap, lapMs/1000);
      lapsState.laps.push({i,dist,lapMs,cumMs,vInst});
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${i}</td><td>${dist}</td><td>${fmt(lapMs)}</td><td>${fmt(cumMs)}</td><td>${vInst.toFixed(2)}</td>`;
      byId('laps-body').appendChild(tr);
      byId('out-done').textContent = String(doneMeters());
      byId('out-time').textContent = fmt(cumMs);
      const avg = kmh(doneMeters(), cumMs/1000);
      byId('out-avg').textContent = avg.toFixed(2);
      byId('out-vma').textContent = avg.toFixed(2);
      byId('meta-done').textContent = String(doneMeters());
      applyDialProgress(byId('dial-progress-laps'), byId('dial-wrap-laps'), (lapsState.total>0?doneMeters()/lapsState.total:0), false);

      if(doneMeters() >= lapsState.total){ stopLaps(); }
    }

    byId('btn-lap').onclick = ()=>{
      if(!lapsState.running) return;
      const now = performance.now();
      let cumMs = now - lapsState.startAt;
      let lapMs;
      if(lapsState.mode==='lap'){ lapMs = now - lapsState.lastLapAt; }
      else{ const prevCum = lapsState.laps.length ? lapsState.laps[lapsState.laps.length-1].cumMs : 0; lapMs = Math.max(0, cumMs - prevCum); }
      lapsState.lastLapAt = now;
      pushLap(lapMs, cumMs);
    };

    byId('btn-reset').onclick = ()=>{
      stopLaps(); lapsState.laps=[]; byId('laps-body').innerHTML='';
      byId('timer-laps').textContent='00:00.0';
      byId('out-done').textContent='0'; byId('out-time').textContent='00:00.0'; byId('out-avg').textContent='0.00'; byId('out-vma').textContent='0.00';
      byId('qrcode').innerHTML='';
      lapsState.startAt=0; lapsState.lastLapAt=0;
      applyDialProgress(byId('dial-progress-laps'), byId('dial-wrap-laps'), 0, false);
      byId('meta-done').textContent='0';
    };

    byId('btn-new').onclick = ()=>{ stopLaps(); go('view-form'); };

    // QR payload conforme ScanProf
    function makeQRPayload(){
      const totalSec = totalElapsedMs()/1000;
      const distance = doneMeters();
      const vitesse = kmh(distance, totalSec);
      const vma = vitesse; // estimation simple
      const laps = lapsState.laps.map(L=>({ tour:L.i, distance:L.dist, temps_tour:fmt(L.lapMs), temps_cumule:fmt(L.cumMs), vitesse:+L.vInst.toFixed(2) }));
      const payload = [{
        nom: lapsState.student.nom,
        prenom: lapsState.student.prenom,
        classe: lapsState.student.classe,
        sexe: (lapsState.student.sexe==='Autre' ? 'M' : lapsState.student.sexe),
        distance: Math.round(distance),
        vitesse: +vitesse.toFixed(2),
        vma: +vma.toFixed(2),
        laps
      }];
      return JSON.stringify(payload);
    }

    byId('btn-generate-qr').onclick = ()=>{
      if(lapsState.laps.length===0){ alert('Ajoute au moins un tour avant de générer le QR.'); return; }
      const data = makeQRPayload();
      const box = byId('qrcode'); box.innerHTML='';
      new QRCode(box, { text:data, width:256, height:256, correctLevel: QRCode.CorrectLevel.M });
    };

    // CSV simple (nom, prenom, classe, intermediaires)
    byId('btn-download-csv').onclick = ()=>{
      if(lapsState.laps.length===0){ alert('Pas de données à exporter.'); return; }
      const inters = lapsState.laps.map(L => fmt(L.lapMs)).join(' | ');
      const headers = ['nom','prenom','classe','intermediaires'];
      const row = [lapsState.student.nom, lapsState.student.prenom, lapsState.student.classe, `"${inters}"`];
      const csv = headers.join(',') + '\n' + row.join(',');
      const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
      const url  = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url; a.download = `chronovitesse_${lapsState.student.nom}_${lapsState.student.prenom}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };

    /* ==============
       MODE MINUTEUR
    ===============*/
    const tm = { totalMs: 3*60*1000, leftMs: 3*60*1000, running:false, startAt:0, tickId:null };
    function updateTimerDown(force=false){
      if(tm.running || force){
        const elapsed = performance.now() - tm.startAt;
        tm.leftMs = Math.max(0, tm.totalMs - elapsed);
      }
      const t = tm.leftMs;
      byId('timer-down').textContent = fmt(t);
      const danger = (t<=10_000);
      applyDialProgress(byId('dial-progress-timer'), byId('dial-wrap-timer'), tm.totalMs>0?(tm.leftMs/tm.totalMs):0, danger);
      if(t<=0){ clearInterval(tm.tickId); tm.running=false; if(navigator.vibrate) navigator.vibrate([120,80,120]); }
    }
    function setTimerFromInputs(){
      const m = Math.max(0, +byId('tm-min').value||0);
      const s = Math.max(0, Math.min(59, +byId('tm-sec').value||0));
      tm.totalMs = (m*60 + s)*1000;
      tm.leftMs = tm.totalMs;
      tm.running=false; clearInterval(tm.tickId); tm.tickId=null;
      byId('timer-down').textContent = fmt(tm.totalMs);
      applyDialProgress(byId('dial-progress-timer'), byId('dial-wrap-timer'), 1, false);
    }
    byId('tm-min').addEventListener('input', setTimerFromInputs);
    byId('tm-sec').addEventListener('input', setTimerFromInputs);
    byId('tm-start').onclick = ()=>{
      if(tm.totalMs<=0){ alert('Définis un temps > 0.'); return; }
      if(tm.running) return;
      tm.running=true; tm.startAt = performance.now() - (tm.totalMs - tm.leftMs);
      tm.tickId = setInterval(()=>updateTimerDown(true), 100);
    };
    byId('tm-pause').onclick = ()=>{ if(!tm.running) return; tm.running=false; clearInterval(tm.tickId); tm.tickId=null; updateTimerDown(true); };
    byId('tm-reset').onclick = ()=>{ tm.running=false; clearInterval(tm.tickId); tm.tickId=null; tm.leftMs=tm.totalMs; updateTimerDown(true); };
    setTimerFromInputs();

    /* =================
       CHRONO SIMPLE
    ==================*/
    const sp = {running:false, startAt:0, tickId:null};
    function updateSimple(){
      const elapsed = performance.now() - sp.startAt;
      byId('timer-up').textContent = fmt(elapsed);
      const r = Math.min(1, ((elapsed/1000)%60)/60);
      const danger = (Math.floor((elapsed/1000)%60) >= 50);
      applyDialProgress(byId('dial-progress-simple'), byId('dial-wrap-simple'), r, danger);
    }
    byId('sp-start').onclick = ()=>{ if(sp.running) return; sp.running=true; sp.startAt=performance.now(); sp.tickId=setInterval(updateSimple, 100); };
    byId('sp-pause').onclick = ()=>{ if(!sp.running) return; sp.running=false; clearInterval(sp.tickId); sp.tickId=null; updateSimple(); };
    byId('sp-reset').onclick = ()=>{ sp.running=false; clearInterval(sp.tickId); sp.tickId=null; byId('timer-up').textContent='00:00.0'; applyDialProgress(byId('dial-progress-simple'), byId('dial-wrap-simple'), 0, false); };
    applyDialProgress(byId('dial-progress-simple'), byId('dial-wrap-simple'), 0, false);
    applyDialProgress(byId('dial-progress-laps'), byId('dial-wrap-laps'), 0, false);
  </script>
</body>
</html>
