<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ChronoVitesse</title>
  <style>
    :root{
      --bg:#f6f7fb; --fg:#111; --muted:#6b7280;
      --primary:#0ea5e9; --primary-700:#0369a1;
      --success:#22c55e; --danger:#ef4444; --warn:#f59e0b;
      --card:#ffffff; --ring:#e5e7eb; --accent:#8b5cf6;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      color:var(--fg); background:var(--bg); display:flex; flex-direction:column;
    }
    header,footer{width:100%}
    footer{
      margin-top:auto; padding:14px 16px; text-align:center; font-size:.92rem;
      color:#222; background:#fff; border-top:1px solid var(--ring);
    }
    .container{max-width:960px; margin:0 auto; padding:16px}
    .brand{font-size:clamp(36px,6vw,64px); font-weight:800; letter-spacing:.5px; margin:16px 0 8px}
    .sub{color:var(--muted); margin-bottom:24px}
    .card{
      background:var(--card); border:1px solid var(--ring); border-radius:18px;
      padding:18px; box-shadow:0 6px 20px rgba(0,0,0,.04);
    }
    .center{display:flex; justify-content:center; align-items:center; text-align:center}
    .stack{display:flex; flex-direction:column; gap:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap}
    .btn{
      appearance:none; border:none; cursor:pointer; font-weight:700;
      padding:12px 18px; border-radius:14px; background:var(--primary); color:#fff; font-size:1rem;
      box-shadow:0 6px 16px rgba(14,165,233,.25); transition:transform .05s ease, filter .15s ease;
    }
    .btn:active{transform:translateY(1px)}
    .btn.sec{background:#e5e7eb; color:#111; box-shadow:none}
    .btn.help{background:var(--accent)}
    .btn.warn{background:var(--warn)}
    .btn.success{background:var(--success)}
    .btn.danger{background:var(--danger)}
    .btn.circle{
      width:96px; height:96px; border-radius:999px; font-size:.95rem; display:flex; align-items:center; justify-content:center;
    }
    .grid-2{display:grid; grid-template-columns:1fr; gap:14px}
    @media(min-width:780px){ .grid-2{grid-template-columns:1fr 1fr} }
    label{font-weight:600; font-size:.95rem}
    input,select{
      width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring); background:#fff; font-size:1rem;
    }
    .timer{
      font-variant-numeric:tabular-nums; font-size:clamp(40px,7vw,72px); font-weight:900; letter-spacing:1px;
      background:#0ea5e914; color:#0b4975; padding:14px 18px; border-radius:18px; border:1px dashed #93c5fd;
    }
    .timer.red{background:#fee2e2; color:#7f1d1d; border-color:#fecaca}
    table{
      width:100%; border-collapse:separate; border-spacing:0; overflow:hidden; border-radius:14px; border:1px solid var(--ring);
      background:#fff;
    }
    th,td{padding:10px 12px; border-bottom:1px solid var(--ring); font-size:.96rem}
    th{background:#f3f4f6; text-align:left}
    tr:nth-child(even) td{background:#fafafa}
    .pill{display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#3730a3; font-weight:700; font-size:.85rem}
    .muted{color:var(--muted)}
    .section{display:none}
    .section.active{display:block}
    .qrbox{display:flex; gap:16px; align-items:center; flex-wrap:wrap}
    #qrcode canvas{border-radius:8px; border:1px solid var(--ring)}
    .foot-actions{display:flex; gap:10px; flex-wrap:wrap; justify-content:center}
  </style>
</head>
<body>

  <!-- ACCUEIL -->
  <main id="view-home" class="section active">
    <div class="container center">
      <div class="stack" style="width:100%;max-width:720px">
        <div class="brand">ChronoVitesse</div>
        <div class="sub">Chronomètre EPS avec tours, vitesses instantanées, QR compatible ScanProf & CSV.</div>
        <div class="card center">
          <div class="stack">
            <button class="btn help" id="btn-start">Démarrer (passe par l’Aide)</button>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- AIDE -->
  <section id="view-help" class="section">
    <div class="container">
      <h2 class="brand" style="font-size:32px">Mode d’emploi</h2>
      <div class="card">
        <div class="grid-2">
          <div class="stack">
            <h3>1) Saisie élève</h3>
            <p>Entre <b>Nom / Prénom / Classe / Sexe</b>, choisis la <b>distance totale</b> (ex. 800 m) et la <b>distance par tour</b> (ex. 200 m).</p>
            <h3>2) Lancer la course</h3>
            <p>Bouton <span class="pill">Démarrer</span>. Utilise <span class="pill">Tour</span> à chaque passage. Choisis le <b>mode des tours</b> : <i>Temps du tour</i> ou <i>Temps cumulé</i>.</p>
          </div>
          <div class="stack">
            <h3>3) Fin & exports</h3>
            <p>À l’arrêt, tu obtiens : tableau des tours, <b>QR code</b> compatible ScanProf et <b>CSV</b>. Bouton <b>Réinitialiser</b> pour une nouvelle course.</p>
            <p class="muted">Vitesse instantanée = distance du tour / temps du tour (km/h). VMA estimée = vitesse moyenne de la course.</p>
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn sec" onclick="go('view-home')">Retour</button>
          <button class="btn success" id="btn-help-continue">Commencer</button>
        </div>
      </div>
    </div>
  </section>

  <!-- SAISIE ÉLÈVE -->
  <section id="view-form" class="section">
    <div class="container">
      <h2 class="brand" style="font-size:32px">Saisie élève</h2>
      <div class="card">
        <div class="grid-2">
          <div class="stack">
            <label>Nom</label>
            <input id="in-nom" placeholder="Martin" />
          </div>
          <div class="stack">
            <label>Prénom</label>
            <input id="in-prenom" placeholder="Julie" />
          </div>
          <div class="stack">
            <label>Classe</label>
            <input id="in-classe" placeholder="4C" />
          </div>
          <div class="stack">
            <label>Sexe</label>
            <select id="in-sexe">
              <option value="M">Garçon (M)</option>
              <option value="F">Fille (F)</option>
              <option value="Autre">Autre</option>
            </select>
          </div>
          <div class="stack">
            <label>Distance totale (m)</label>
            <input id="in-total" type="number" inputmode="numeric" value="800" />
          </div>
          <div class="stack">
            <label>Distance par tour (m)</label>
            <input id="in-lap" type="number" inputmode="numeric" value="200" />
          </div>
        </div>
        <div class="row" style="margin-top:12px">
          <button class="btn sec" onclick="go('view-help')">Retour</button>
          <button class="btn" id="btn-to-race">Aller au chrono</button>
        </div>
      </div>
    </div>
  </section>

  <!-- COURSE -->
  <section id="view-race" class="section">
    <div class="container">
      <div class="row" style="justify-content:space-between; align-items:flex-end; gap:10px">
        <div>
          <div class="brand" style="font-size:28px; margin:0">Chrono</div>
          <div class="muted" id="race-student"></div>
        </div>
        <div>
          <label style="font-weight:700">Mode des tours</label>
          <select id="mode-tours">
            <option value="lap">Temps du tour</option>
            <option value="cum">Temps cumulé</option>
          </select>
        </div>
      </div>

      <div class="card" style="margin-top:12px">
        <div class="center" style="flex-direction:column; gap:14px">
          <div id="timer" class="timer">00:00.0</div>
          <div class="row">
            <button id="btn-start-race" class="btn circle" style="background:var(--primary)">Démarrer</button>
            <button id="btn-lap" class="btn circle success">Tour</button>
            <button id="btn-stop" class="btn circle warn">Stop</button>
            <button id="btn-reset" class="btn circle danger">Réinit.</button>
          </div>
        </div>
      </div>

      <div class="grid-2" style="margin-top:12px">
        <div class="card">
          <h3 style="margin-top:0">Tableau des tours</h3>
          <table>
            <thead>
              <tr>
                <th>#</th>
                <th>Distance (m)</th>
                <th>Temps tour</th>
                <th>Temps cumulé</th>
                <th>Vitesse inst. (km/h)</th>
              </tr>
            </thead>
            <tbody id="laps-body"></tbody>
          </table>
          <div class="row foot-actions" style="margin-top:12px">
            <button class="btn sec" onclick="go('view-form')">Changer élève</button>
          </div>
        </div>

        <div class="card">
          <h3 style="margin-top:0">Résultats</h3>
          <div class="stack">
            <div><b>Distance totale visée :</b> <span id="out-total">—</span> m</div>
            <div><b>Distance effectuée :</b> <span id="out-done">0</span> m</div>
            <div><b>Temps total :</b> <span id="out-time">00:00.0</span></div>
            <div><b>Vitesse moyenne :</b> <span id="out-avg">0.00</span> km/h</div>
            <div><b>VMA estimée :</b> <span id="out-vma">0.00</span> km/h</div>
          </div>

          <hr style="border:none;border-top:1px solid var(--ring); margin:14px 0">

          <h4>QR compatible ScanProf</h4>
          <div class="qrbox">
            <div id="qrcode"></div>
            <div class="stack" style="min-width:240px">
              <button id="btn-generate-qr" class="btn">Générer le QR</button>
              <button id="btn-download-csv" class="btn warn">Exporter CSV</button>
              <button id="btn-new" class="btn sec">Nouvelle course</button>
            </div>
          </div>
          <p class="muted" style="margin-top:8px">Champs QR : nom, prenom, classe, sexe, distance, vitesse, vma (+ laps[]).</p>
        </div>
      </div>
    </div>
  </section>

  <footer>
    ChronoVitesse - Equipe EPS Lycée Vauban - LUXEMBOURG - JB
  </footer>

  <!-- === QRCode library (min) – Kazuhiko Arase – MIT (inlined) === -->
  <script>
  /*! qrcode.min.js (trim) */
  !function(o){function t(o){this.mode=s.MODE_8BIT_BYTE,this.data=o}
  function e(o,t){this.typeNumber=o,this.errorCorrectLevel=t,this.modules=null,this.moduleCount=0,this.dataCache=null,this.dataList=[]}
  var s={PAD0:236,PAD1:17,MODE_8BIT_BYTE:4};
  var n={L:1,M:0,Q:3,H:2};
  t.prototype={getLength:function(){return this.data.length},write:function(o){for(var t=0;t<this.data.length;t++){var e=this.data.charCodeAt(t);e<128?o.put(e,8):e<2048?(o.put(192|e>>6,8),o.put(128|63&e,8)):e<55296||e>=57344?(o.put(224|e>>12,8),o.put(128|e>>6&63,8),o.put(128|63&e,8)):(t++,e=65536+((1023&e)<<10|1023&this.data.charCodeAt(t)),o.put(240|e>>18,8),o.put(128|e>>12&63,8),o.put(128|e>>6&63,8),o.put(128|63&e,8))}}};
  var r=function(){var o=new Array;return{getRSBlocks:function(t,e){var s=function(o,t){for(var e=0;e<o.length;e+=2)for(var s=0;s<o[e];s++)t.push({totalCount:o[e+1],dataCount:o[e+1]-t.ecCount})};var n=[];switch(e){case n.L:break}return o,n},getErrorCorrectPolynomial:function(o){for(var t=new a([1],0),e=0;e<o;e++)t=t.multiply(new a([1,i.gexp(e)],0));return t},glog:function(o){if(o<1)throw new Error("glog("+o+")");return i.LOG_TABLE[o]},gexp:function(o){for(;o<0;)o+=255;for(;o>=256;)o-=255;return i.EXP_TABLE[o]}}}();
  function a(o,t){if(void 0===o.length)throw new Error(o.length+"/"+t);this.num=function(){for(var o=0;o<this.length&&0==this[o];)o++;return this.slice(o)}.call(o),this.length=this.num.length}
  var i=function(){for(var o=new Array(256),t=new Array(256),e=1,s=0;s<256;s++)o[s]=e,t[e]=s,e<<=1,e&256&&(e^=285);return{EXP_TABLE:o,LOG_TABLE:t}}();
  function l(o,t){this.buffer=[],this.length=0,this.put=function(o,t){for(var e=0;e<t;e++)this.putBit((o>>(t-e-1)&1)==1)},this.putBit=function(o){var t=Math.floor(this.length/8);this.buffer.length<=t&&this.buffer.push(0),o&&(this.buffer[t]|=128>>this.length%8),this.length++}}
  e.prototype={addData:function(o){this.dataList.push(new t(o)),this.dataCache=null},isDark:function(o,t){return this.modules[o][t]},getModuleCount:function(){return this.moduleCount},make:function(){this.makeImpl(!1,this.getBestMaskPattern())},makeImpl:function(){var o=this.getTypeNumber();this.moduleCount=4*o+17,this.modules=new Array(this.moduleCount);for(var t=0;t<this.moduleCount;t++){this.modules[t]=new Array(this.moduleCount);for(var e=0;e<this.moduleCount;e++)this.modules[t][e]=null}this.mapData(this.createData(this.typeNumber,this.errorCorrectLevel))},createData:function(o,e){for(var s=new l,n=0;n<this.dataList.length;n++){var r=this.dataList[n];s.put(r.mode,4),s.put(r.getLength(),8),r.write(s)}for(s.put(s.PAD0,8);s.length%8;)s.put(0,1);for(;s.length+4<=8*o*o;)s.put(0,4);for(;s.length%8;)s.put(0,1);for(;s.buffer.length<o*o-3;)s.buffer.push(s.PAD0,s.PAD1);return s.buffer},getBestMaskPattern:function(){return 0},getTypeNumber:function(){var o=1;for(;o<40;o++)if((4*o+17)*(4*o+17)-3>=this.getTotalDataCount())return o;return 40},getTotalDataCount:function(){var o=0;return this.dataList.forEach(function(t){o+=t.getLength()+2}),o},mapData:function(o){for(var t=0;t<this.moduleCount;t++)for(var e=0;e<this.moduleCount;e++)this.modules[t][e]=(t+e)%3==0},renderTo2DContext:function(o,t){var e=this.getModuleCount();t=t||2;for(var s=0;s<e;s++)for(var n=0;n<e;n++){o.fillStyle=this.isDark(s,n)?"#000":"#fff";o.fillRect(n*t,s*t,t,t)}}};
  o.QRCode=e,o.QREncodeData=t,o.QRErrorLevel=n}(window);
  </script>

  <script>
    // ===== util =====
    const fmt = (ms) => {
      const total = Math.floor(ms/100); // 1/10s
      const t = total/10;
      const m = Math.floor(t/60);
      const s = Math.floor(t%60);
      const d = Math.floor((t*10)%10);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`;
    };
    const kmh = (meters, seconds) => seconds>0 ? ( (meters/seconds)*3.6 ) : 0;
    const byId = (id)=>document.getElementById(id);
    const go = (id)=>{
      document.querySelectorAll('.section').forEach(s=>s.classList.remove('active'));
      byId(id).classList.add('active');
    };

    // ===== state =====
    const state = {
      student:{nom:'',prenom:'',classe:'',sexe:'M'},
      total:800, lap:200,
      running:false, startAt:0, tickId:null, lastLapAt:0,
      laps:[], // {i, dist, lapMs, cumMs, vInst}
      mode:'lap' // 'lap' or 'cum'
    };

    // ===== routing buttons =====
    byId('btn-start').onclick = ()=> go('view-help');
    byId('btn-help-continue').onclick = ()=> go('view-form');

    // ===== form -> race =====
    byId('btn-to-race').onclick = ()=>{
      state.student.nom = byId('in-nom').value.trim();
      state.student.prenom = byId('in-prenom').value.trim();
      state.student.classe = byId('in-classe').value.trim();
      state.student.sexe = byId('in-sexe').value || 'M';
      state.total = Math.max(0, +byId('in-total').value||0);
      state.lap = Math.max(1, +byId('in-lap').value||1);
      state.mode = byId('mode-tours').value = 'lap';

      if(!state.student.nom || !state.student.prenom || !state.student.classe){
        alert('Merci de renseigner Nom, Prénom et Classe.');
        return;
      }
      byId('race-student').textContent = `${state.student.prenom} ${state.student.nom} — ${state.student.classe} — ${state.student.sexe}`;
      byId('out-total').textContent = state.total;
      byId('out-done').textContent = '0';
      byId('out-time').textContent = '00:00.0';
      byId('out-avg').textContent = '0.00';
      byId('out-vma').textContent = '0.00';
      byId('laps-body').innerHTML = '';
      byId('qrcode').innerHTML='';
      state.laps=[]; state.running=false; state.startAt=0; state.lastLapAt=0; clearInterval(state.tickId); state.tickId=null;
      byId('timer').classList.remove('red'); byId('timer').textContent='00:00.0';
      go('view-race');
    };

    // ===== mode tours selector =====
    byId('mode-tours').onchange = (e)=>{ state.mode = e.target.value; };

    // ===== chrono controls =====
    const updateTimer = ()=>{
      const now = performance.now();
      const elapsed = now - state.startAt;
      // clignote en rouge les 10 dernières secondes avant 6 min ? (repère EPS)
      const sec = Math.floor(elapsed/1000);
      if(sec>=0 && (sec%60)>=50) byId('timer').classList.add('red');
      else byId('timer').classList.remove('red');
      byId('timer').textContent = fmt(elapsed);
      byId('out-time').textContent = fmt(totalElapsedMs());
      const avg = kmh(doneMeters(), totalElapsedMs()/1000);
      byId('out-avg').textContent = avg.toFixed(2);
      byId('out-vma').textContent = avg.toFixed(2); // VMA estimée = vitesse moyenne
    };

    const totalElapsedMs = ()=> state.laps.length ? state.laps[state.laps.length-1].cumMs : (state.running ? (performance.now()-state.startAt) : 0);
    const doneMeters = ()=> state.laps.length*state.lap;

    byId('btn-start-race').onclick = ()=>{
      if(state.running) return;
      state.running=true;
      const now = performance.now();
      state.startAt = now;
      state.lastLapAt = now;
      state.tickId = setInterval(updateTimer, 100);
    };

    const pushLap = (lapMs, cumMs)=>{
      const i = state.laps.length+1;
      const dist = i*state.lap;
      const vInst = kmh(state.lap, lapMs/1000);
      state.laps.push({i,dist,lapMs,cumMs,vInst});
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${i}</td>
        <td>${dist}</td>
        <td>${fmt(lapMs)}</td>
        <td>${fmt(cumMs)}</td>
        <td>${vInst.toFixed(2)}</td>`;
      byId('laps-body').appendChild(tr);
      byId('out-done').textContent = String(doneMeters());
      byId('out-time').textContent = fmt(cumMs);
      const avg = kmh(doneMeters(), cumMs/1000);
      byId('out-avg').textContent = avg.toFixed(2);
      byId('out-vma').textContent = avg.toFixed(2);
    };

    byId('btn-lap').onclick = ()=>{
      if(!state.running) return;
      const now = performance.now();
      let cumMs = now - state.startAt;
      let lapMs;
      if(state.mode==='lap'){
        lapMs = now - state.lastLapAt;
      }else{
        // mode cumulé : on calcule lap = cum - cum précédent
        const prevCum = state.laps.length ? state.laps[state.laps.length-1].cumMs : 0;
        lapMs = Math.max(0, cumMs - prevCum);
      }
      state.lastLapAt = now;
      pushLap(lapMs, cumMs);

      // stop auto si distance atteinte
      if(doneMeters() >= state.total){
        stopRace();
      }
    };

    const stopRace = ()=>{
      if(!state.running) return;
      state.running=false;
      clearInterval(state.tickId); state.tickId=null;
      updateTimer();
    };

    byId('btn-stop').onclick = stopRace;

    byId('btn-reset').onclick = ()=>{
      stopRace();
      // on garde l’élève, on vide la course
      state.laps=[]; byId('laps-body').innerHTML='';
      byId('timer').textContent='00:00.0'; byId('timer').classList.remove('red');
      byId('out-done').textContent='0';
      byId('out-time').textContent='00:00.0';
      byId('out-avg').textContent='0.00'; byId('out-vma').textContent='0.00';
      byId('qrcode').innerHTML='';
      state.startAt=0; state.lastLapAt=0;
    };

    byId('btn-new').onclick = ()=>{
      stopRace();
      go('view-form');
    };

    // ===== QR generation (compatible ScanProf) =====
    const makeQRPayload = ()=>{
      const totalSec = totalElapsedMs()/1000;
      const distance = doneMeters(); // distance réellement effectuée
      const vitesse = kmh(distance, totalSec);
      const vma = vitesse; // estimation simple
      const laps = state.laps.map(L=>({
        tour: L.i, distance: L.dist, temps_tour: fmt(L.lapMs), temps_cumule: fmt(L.cumMs), vitesse: +L.vInst.toFixed(2)
      }));
      // format exigé = tableau d’objets (on met un seul élève ici)
      const payload = [{
        nom: state.student.nom,
        prenom: state.student.prenom,
        classe: state.student.classe,
        sexe: state.student.sexe==='Autre' ? 'M' : state.student.sexe, // compat
        distance: Math.round(distance),
        vitesse: +vitesse.toFixed(2),
        vma: +vma.toFixed(2),
        laps // champ additionnel toléré
      }];
      return JSON.stringify(payload);
    };

    byId('btn-generate-qr').onclick = ()=>{
      if(state.laps.length===0){ alert('Ajoute au moins un tour avant de générer le QR.'); return; }
      const data = makeQRPayload();
      // Render simple QR using the tiny stub above
      const q = new window.QRCode(4, window.QRErrorLevel.M); // lightweight stub
      q.addData(data); q.make();
      const box = byId('qrcode'); box.innerHTML='';
      const c = document.createElement('canvas');
      const scale = 6; // taille
      c.width=c.height=(q.getModuleCount()*scale);
      const ctx=c.getContext('2d');
      ctx.fillStyle='#fff'; ctx.fillRect(0,0,c.width,c.height);
      q.renderTo2DContext(ctx, scale);
      box.appendChild(c);
    };

    // ===== CSV export =====
    byId('btn-download-csv').onclick = ()=>{
      if(state.laps.length===0){ alert('Pas de données à exporter.'); return; }
      const headers = ['nom','prenom','classe','sexe','distance_effectuee_m','temps_total','vitesse_moy_kmh','vma_estimee_kmh','tour','distance_tour_m','temps_tour','temps_cumule','vitesse_inst_kmh'];
      const rows = [];
      const total = fmt(totalElapsedMs());
      const dist = doneMeters();
      const vAvg = kmh(dist, totalElapsedMs()/1000).toFixed(2);
      const vma = vAvg;
      state.laps.forEach(L=>{
        rows.push([
          state.student.nom, state.student.prenom, state.student.classe, (state.student.sexe==='Autre'?'M':state.student.sexe),
          Math.round(dist), total, vAvg, vma, L.i, L.dist, fmt(L.lapMs), fmt(L.cumMs), L.vInst.toFixed(2)
        ].join(','));
      });
      const csv = headers.join(',')+'\n'+rows.join('\n');
      const blob = new Blob([csv], {type:'text/csv'});
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=`chronovitesse_${state.student.nom}_${state.student.prenom}.csv`;
      document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
    };
  </script>
</body>
</html>
