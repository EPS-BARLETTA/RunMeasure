<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>ChronoVitesse ‚Äî EPS</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@500;600;700;800&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#f7fafc; --fg:#0f172a; --muted:#64748b;
    --ring:#e2e8f0; --card:#ffffff;
    --primary:#2563eb; --primary-600:#1d4ed8; --primary-50:#eef2ff;
    --green:#16a34a; --amber:#f59e0b; --red:#ef4444; --violet:#7c3aed; --cyan:#0891b2;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; font-family:"Inter",system-ui,ui-sans-serif,Segoe UI,Roboto,Arial,sans-serif;
    background:linear-gradient(180deg,#f8fafc 0%,#ffffff 60%);
    color:var(--fg); display:flex; flex-direction:column;
  }
  .container{max-width:1100px; margin:0 auto; padding:20px}
  header .brand{font-size:clamp(34px,5vw,58px); font-weight:800; letter-spacing:.2px; margin:6px 0 2px}
  header .sub{color:var(--muted); margin:0 0 12px}
  .section{display:none}
  .section.active{display:block}
  .card{
    background:var(--card); border:1px solid var(--ring);
    border-radius:18px; padding:18px; box-shadow:0 10px 30px rgba(15,23,42,.05);
  }
  .stack{display:flex; flex-direction:column; gap:14px}
  .row{display:flex; flex-wrap:wrap; gap:12px}
  .grid{display:grid; gap:14px}
  .grid.two{grid-template-columns:1fr}
  @media(min-width:860px){ .grid.two{grid-template-columns:1fr 1fr} }
  .tiles{display:grid; gap:16px; grid-template-columns:1fr; }
  @media(min-width:720px){ .tiles{grid-template-columns:repeat(3,1fr);} }
  .tile{
    border-radius:18px; padding:18px; color:#fff; min-height:150px; position:relative;
    display:flex; flex-direction:column; justify-content:space-between; box-shadow:0 12px 24px rgba(0,0,0,.08);
    transition:transform .08s ease, box-shadow .15s ease; cursor:pointer; user-select:none;
  }
  .tile:hover{transform:translateY(-2px); box-shadow:0 16px 30px rgba(0,0,0,.12)}
  .tile h3{margin:0 0 8px; font-size:20px}
  .tile p{margin:0; opacity:.9}
  .tile .ico{font-size:28px; opacity:.9}
  .t-blue{background:linear-gradient(135deg,#2563eb,#3b82f6)}
  .t-green{background:linear-gradient(135deg,#16a34a,#22c55e)}
  .t-amber{background:linear-gradient(135deg,#f59e0b,#fbbf24)}
  .t-violet{background:linear-gradient(135deg,#7c3aed,#8b5cf6)}
  .t-cyan{background:linear-gradient(135deg,#0891b2,#06b6d4)}
  .t-rose{background:linear-gradient(135deg,#e11d48,#fb7185)}

  .btn{
    appearance:none; border:none; cursor:pointer; font-weight:800;
    padding:12px 18px; border-radius:14px; background:var(--primary); color:#fff; font-size:1rem;
    box-shadow:0 10px 20px rgba(37,99,235,.22); transition:transform .05s ease, filter .15s ease;
  }
  .btn:active{transform:translateY(1px)}
  .btn.sec{background:#e2e8f0; color:#0f172a; box-shadow:none}
  .btn.ghost{background:transparent; border:1px solid var(--ring); color:var(--fg)}
  .btn.green{background:var(--green)} .btn.amber{background:var(--amber)}
  .btn.red{background:var(--red)} .btn.violet{background:var(--violet)}
  .btn.cyan{background:var(--cyan)}
  .btn.xl{font-size:18px; padding:16px 22px; border-radius:16px}
  .btn.circle{width:104px; height:104px; border-radius:999px; font-size:.95rem; display:flex; align-items:center; justify-content:center}

  label{font-weight:700; font-size:.95rem}
  input,select{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid var(--ring);
    background:#fff; font-size:1rem;
  }
  table{width:100%; border-collapse:separate; border-spacing:0; border-radius:14px; overflow:hidden; border:1px solid var(--ring); background:#fff}
  th,td{padding:10px 12px; border-bottom:1px solid var(--ring); font-size:.96rem}
  th{background:#f1f5f9; text-align:left}
  tr:nth-child(even) td{background:#fbfdff}
  .muted{color:var(--muted)}
  .badge{display:inline-block; padding:6px 10px; border-radius:999px; background:#eef2ff; color:#1d4ed8; font-weight:800; font-size:.8rem}

  /* Dial */
  .dial-wrap{position:relative; width:300px; height:300px}
  .dial{width:300px; height:300px; display:block; transform:rotate(-90deg)}
  .dial-track{stroke:#e5e7eb; stroke-width:18; fill:none}
  .dial-progress{stroke:var(--primary); stroke-width:18; fill:none; stroke-linecap:round; transition:stroke-dashoffset .15s ease}
  .dial-center{position:absolute; inset:0; display:flex; flex-direction:column; align-items:center; justify-content:center; gap:6px}
  .dial-time{font-variant-numeric:tabular-nums; font-size:52px; font-weight:900; letter-spacing:.5px; color:#0b4975}
  .dial-meta{font-size:.95rem; color:var(--muted); font-weight:700}
  .alert .dial-progress{stroke:var(--red)} .alert .dial-time{color:#7f1d1d}

  footer{
    margin-top:auto; text-align:center; padding:16px; background:#0f172a; color:#e2e8f0; font-weight:700; letter-spacing:.2px;
  }
</style>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>

<header class="container">
  <div class="brand">ChronoVitesse</div>
  <div class="sub">Outils chrono & tests pour l‚ÄôEPS ‚Äî simple, rapide, lisible.</div>
</header>

<!-- ACCUEIL -->
<section id="home" class="section active">
  <div class="container">
    <div class="card" style="padding:26px">
      <div class="row" style="align-items:center; justify-content:space-between">
        <div class="stack">
          <h2 style="margin:0">Bienvenue üëã</h2>
          <p class="muted" style="margin:0">Choisissez un mode et lancez le chrono.</p>
        </div>
        <button id="go-modes" class="btn xl green">Choisir un mode</button>
      </div>
    </div>
  </div>
</section>

<!-- MODES -->
<section id="modes" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2 style="margin:0">Choisir un mode</h2>
      <button class="btn sec" onclick="nav('home')">‚Üê Retour</button>
    </div>
    <div class="tiles" style="margin-top:14px">
      <div class="tile t-green" onclick="nav('timer')">
        <div class="ico">‚è±</div>
        <div>
          <h3>Minuteur</h3>
          <p>D√©compte (mm:ss), gros cadran, pause/r√©init.</p>
        </div>
      </div>
      <div class="tile t-cyan" onclick="nav('simple')">
        <div class="ico">üïí</div>
        <div>
          <h3>Chrono simple</h3>
          <p>Compteur ascendant, clair et lisible.</p>
        </div>
      </div>
      <div class="tile t-blue" onclick="nav('help-laps')">
        <div class="ico">üèÅ</div>
        <div>
          <h3>Chrono avec tours</h3>
          <p>√âl√®ve, tours, QR, CSV ‚Äî mode course.</p>
        </div>
      </div>
      <div class="tile t-violet" onclick="nav('vma')">
        <div class="ico">üéØ</div>
        <div>
          <h3>Test VMA (navette)</h3>
          <p>Paliers, vitesses, meilleur palier, QR.</p>
        </div>
      </div>
      <div class="tile t-amber" onclick="nav('chase')">
        <div class="ico">üèÉ‚Äç‚ôÄÔ∏èüèÉ‚Äç‚ôÇÔ∏è</div>
        <div>
          <h3>Course poursuite</h3>
          <p>Deux √©l√®ves, gagnant, QR r√©cap.</p>
        </div>
      </div>
      <div class="tile t-rose" onclick="nav('series')">
        <div class="ico">üìã</div>
        <div>
          <h3>S√©rie multi-√©preuves</h3>
          <p>Encha√Ænez plusieurs chronos, QR final.</p>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- AIDE LAPS -->
<section id="help-laps" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center"><h2>Mode d‚Äôemploi ‚Äî Chrono avec tours</h2><button class="btn sec" onclick="nav('modes')">‚Üê Modes</button></div>
    <div class="card">
      <div class="grid two">
        <div class="stack">
          <div class="badge">1</div>
          <p>Saisie <b>Nom/Pr√©nom/Classe/Sexe</b>, <b>Distance totale</b> et <b>Par tour</b>.</p>
          <div class="badge">2</div>
          <p>D√©marre, puis <b>Tour</b> √† chaque passage. Mode : <i>Temps du tour</i> ou <i>Temps cumul√©</i>.</p>
          <div class="badge">3</div>
          <p>Arr√™t ‚Üí Tableau, QR ‚Äúinfos de course‚Äù, CSV (simple/d√©taill√©).</p>
        </div>
        <div class="stack">
          <p class="muted">Conseil : grands boutons pour √©viter les erreurs, chiffres tabulaires, couleurs contrast√©es (plein soleil).</p>
          <button class="btn violet" onclick="nav('form')">Saisie √©l√®ve ‚Üí</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- SAISIE LAPS -->
<section id="form" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center"><h2>Saisie √©l√®ve</h2><button class="btn sec" onclick="nav('help-laps')">‚Üê Aide</button></div>
    <div class="card">
      <div class="grid two">
        <div class="stack"><label>Nom</label><input id="in-nom" placeholder="Martin"></div>
        <div class="stack"><label>Pr√©nom</label><input id="in-prenom" placeholder="Julie"></div>
        <div class="stack"><label>Classe</label><input id="in-classe" placeholder="4C"></div>
        <div class="stack">
          <label>Sexe</label>
          <select id="in-sexe"><option value="M">M</option><option value="F">F</option><option value="Autre">Autre</option></select>
        </div>
        <div class="stack"><label>Distance totale (m)</label><input id="in-total" type="number" value="800"></div>
        <div class="stack"><label>Distance par tour (m)</label><input id="in-lap" type="number" value="200"></div>
      </div>
      <div class="row" style="margin-top:10px"><button class="btn" id="to-race">Aller au chrono ‚Üí</button></div>
    </div>
  </div>
</section>

<!-- CHRONO LAPS -->
<section id="race" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center">
      <div>
        <h2 style="margin:0">Chrono (Tours)</h2>
        <div class="muted" id="race-student"></div>
      </div>
      <div class="row">
        <label style="align-self:center">Mode tours</label>
        <select id="mode-tours"><option value="lap">Temps du tour</option><option value="cum">Temps cumul√©</option></select>
        <button class="btn sec" onclick="nav('form')">‚Ü∫ changer √©l√®ve</button>
      </div>
    </div>

    <div class="card" style="margin-top:12px">
      <div class="stack" style="align-items:center">
        <div class="dial-wrap" id="dial-wrap-laps">
          <svg class="dial" viewBox="0 0 240 240"><circle class="dial-track" cx="120" cy="120" r="96"></circle><circle class="dial-progress" id="dial-progress-laps" cx="120" cy="120" r="96"></circle></svg>
          <div class="dial-center"><div id="timer-laps" class="dial-time">00:00.0</div><div class="dial-meta"><span id="meta-done">0</span>/<span id="meta-total">‚Äî</span> m</div></div>
        </div>
        <div class="row">
          <button id="start-laps" class="btn circle green">D√©marrer</button>
          <button id="lap" class="btn circle cyan">Tour</button>
          <button id="stop-laps" class="btn circle amber">Stop</button>
          <button id="reset-laps" class="btn circle red">R√©init.</button>
        </div>
      </div>
    </div>

    <div class="grid two" style="margin-top:12px">
      <div class="card">
        <h3 style="margin:0 0 8px">Tableau des tours</h3>
        <table><thead><tr><th>#</th><th>Distance (m)</th><th>Temps tour</th><th>Temps cumul√©</th><th>Vitesse (km/h)</th></tr></thead><tbody id="laps-body"></tbody></table>
      </div>

      <div class="card">
        <h3 style="margin:0 0 8px">Exports & QR</h3>
        <div class="row">
          <div id="qrcode" class="card" style="border:1px dashed var(--ring); padding:8px"></div>
          <div class="stack" style="min-width:260px">
            <button id="qr-laps" class="btn violet">QR infos de course</button>
            <button id="csv-laps-simple" class="btn amber">CSV simple (1 ligne)</button>
            <button id="csv-laps-detail" class="btn amber">CSV d√©taill√© (par tour)</button>
            <button id="new-laps" class="btn ghost">Nouvelle course</button>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- MINUTEUR -->
<section id="timer" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center"><h2>Minuteur</h2><button class="btn sec" onclick="nav('modes')">‚Üê Modes</button></div>
    <div class="card" style="margin-top:12px">
      <div class="stack" style="align-items:center">
        <div class="row">
          <div class="stack"><label>Minutes</label><input id="tm-min" type="number" min="0" value="3"></div>
          <div class="stack"><label>Secondes</label><input id="tm-sec" type="number" min="0" max="59" value="0"></div>
        </div>
        <div class="dial-wrap" id="dial-wrap-timer">
          <svg class="dial" viewBox="0 0 240 240"><circle class="dial-track" cx="120" cy="120" r="96"></circle><circle class="dial-progress" id="dial-progress-timer" cx="120" cy="120" r="96"></circle></svg>
          <div class="dial-center"><div id="timer-down" class="dial-time">03:00.0</div><div class="dial-meta">D√©compte</div></div>
        </div>
        <div class="row">
          <button id="tm-start" class="btn circle green">D√©marrer</button>
          <button id="tm-pause" class="btn circle amber">Pause</button>
          <button id="tm-reset" class="btn circle red">R√©init.</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- CHRONO SIMPLE -->
<section id="simple" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center"><h2>Chrono simple</h2><button class="btn sec" onclick="nav('modes')">‚Üê Modes</button></div>
    <div class="card" style="margin-top:12px">
      <div class="stack" style="align-items:center">
        <div class="dial-wrap" id="dial-wrap-simple">
          <svg class="dial" viewBox="0 0 240 240"><circle class="dial-track" cx="120" cy="120" r="96"></circle><circle class="dial-progress" id="dial-progress-simple" cx="120" cy="120" r="96"></circle></svg>
          <div class="dial-center"><div id="timer-up" class="dial-time">00:00.0</div><div class="dial-meta">Comptage</div></div>
        </div>
        <div class="row">
          <button id="sp-start" class="btn circle green">D√©marrer</button>
          <button id="sp-pause" class="btn circle amber">Pause</button>
          <button id="sp-reset" class="btn circle red">R√©init.</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- TEST VMA (NAVETTE) -->
<section id="vma" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2>Test VMA (navette)</h2>
      <button class="btn sec" onclick="nav('modes')">‚Üê Modes</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="grid two">
        <div class="stack">
          <label>Nom</label><input id="vma-nom">
          <label>Pr√©nom</label><input id="vma-prenom">
          <label>Classe</label><input id="vma-classe">
          <label>Sexe</label>
          <select id="vma-sexe"><option>M</option><option>F</option><option>Autre</option></select>
        </div>
        <div class="stack">
          <label>Palier initial</label><input id="vma-start" type="number" value="1" min="1">
          <label>Palier max (objectif)</label><input id="vma-max" type="number" value="20" min="1">
          <label>Dur√©e palier (s)</label><input id="vma-palier-sec" type="number" value="60" min="10">
          <label>Incr√©ment vitesse (km/h par palier)</label><input id="vma-inc" type="number" value="0.5" step="0.1">
        </div>
      </div>
      <div class="stack" style="align-items:center; margin-top:10px">
        <div class="dial-wrap" id="dial-wrap-vma">
          <svg class="dial" viewBox="0 0 240 240"><circle class="dial-track" cx="120" cy="120" r="96"></circle><circle class="dial-progress" id="dial-progress-vma" cx="120" cy="120" r="96"></circle></svg>
          <div class="dial-center"><div id="vma-timer" class="dial-time">00:00.0</div><div class="dial-meta">Palier <span id="vma-palier">1</span> ‚Äî <span id="vma-speed">8.0</span> km/h</div></div>
        </div>
        <div class="row">
          <button id="vma-start-btn" class="btn circle green">D√©marrer</button>
          <button id="vma-next" class="btn circle cyan">Palier +1</button>
          <button id="vma-stop" class="btn circle amber">Stop</button>
          <button id="vma-reset" class="btn circle red">R√©init.</button>
        </div>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div class="card">
          <h3 style="margin:0 0 8px">Historique des paliers</h3>
          <table><thead><tr><th>#</th><th>Palier</th><th>Vitesse (km/h)</th><th>Dur√©e</th></tr></thead><tbody id="vma-body"></tbody></table>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px">QR Test VMA</h3>
          <div class="row">
            <div id="qrcode-vma" class="card" style="border:1px dashed var(--ring); padding:8px"></div>
            <div class="stack">
              <button id="vma-qr" class="btn violet">QR VMA</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- COURSE POURSUITE -->
<section id="chase" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2>Course poursuite (A vs B)</h2>
      <button class="btn sec" onclick="nav('modes')">‚Üê Modes</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="grid two">
        <div class="stack">
          <h3 style="margin:0">√âl√®ve A</h3>
          <label>Nom</label><input id="chA-nom">
          <label>Pr√©nom</label><input id="chA-prenom">
          <label>Classe</label><input id="chA-classe">
        </div>
        <div class="stack">
          <h3 style="margin:0">√âl√®ve B</h3>
          <label>Nom</label><input id="chB-nom">
          <label>Pr√©nom</label><input id="chB-prenom">
          <label>Classe</label><input id="chB-classe">
        </div>
      </div>
      <div class="grid two" style="margin-top:12px">
        <div class="card stack" style="align-items:center">
          <div class="dial-wrap">
            <svg class="dial" viewBox="0 0 240 240"><circle class="dial-track" cx="120" cy="120" r="96"></circle><circle class="dial-progress" id="dial-chA" cx="120" cy="120" r="96"></circle></svg>
            <div class="dial-center"><div id="chA-time" class="dial-time">00:00.0</div><div class="dial-meta">√âl√®ve A</div></div>
          </div>
          <div class="row"><button id="chA-lap" class="btn cyan">Tour A</button></div>
          <table><thead><tr><th>#</th><th>Temps tour</th><th>Cumul√©</th></tr></thead><tbody id="chA-body"></tbody></table>
        </div>
        <div class="card stack" style="align-items:center">
          <div class="dial-wrap">
            <svg class="dial" viewBox="0 0 240 240"><circle class="dial-track" cx="120" cy="120" r="96"></circle><circle class="dial-progress" id="dial-chB" cx="120" cy="120" r="96"></circle></svg>
            <div class="dial-center"><div id="chB-time" class="dial-time">00:00.0</div><div class="dial-meta">√âl√®ve B</div></div>
          </div>
          <div class="row"><button id="chB-lap" class="btn cyan">Tour B</button></div>
          <table><thead><tr><th>#</th><th>Temps tour</th><th>Cumul√©</th></tr></thead><tbody id="chB-body"></tbody></table>
        </div>
      </div>
      <div class="row" style="justify-content:center; gap:16px; margin-top:12px">
        <button id="ch-start" class="btn xl green">D√©marrer</button>
        <button id="ch-stop" class="btn xl amber">Stop</button>
        <button id="ch-reset" class="btn xl red">R√©init.</button>
      </div>
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">QR Course poursuite</h3>
        <div class="row">
          <div id="qrcode-chase" class="card" style="border:1px dashed var(--ring); padding:8px"></div>
          <button id="ch-qr" class="btn violet">QR Poursuite</button>
        </div>
      </div>
    </div>
  </div>
</section>

<!-- S√âRIE MULTI-√âPREUVES -->
<section id="series" class="section">
  <div class="container">
    <div class="row" style="justify-content:space-between; align-items:center">
      <h2>S√©rie multi-√©preuves</h2>
      <button class="btn sec" onclick="nav('modes')">‚Üê Modes</button>
    </div>
    <div class="card" style="margin-top:12px">
      <div class="grid two">
        <div class="stack">
          <label>Nom</label><input id="se-nom">
          <label>Pr√©nom</label><input id="se-prenom">
          <label>Classe</label><input id="se-classe">
          <div class="row">
            <input id="se-epreuve-name" placeholder="Nom √©preuve (ex: 200m)">
            <button id="se-add" class="btn cyan">Ajouter √©preuve</button>
          </div>
          <ul id="se-list" class="stack" style="padding:0; list-style:none;"></ul>
        </div>
        <div class="stack" style="align-items:center">
          <div class="dial-wrap">
            <svg class="dial" viewBox="0 0 240 240"><circle class="dial-track" cx="120" cy="120" r="96"></circle><circle class="dial-progress" id="dial-se" cx="120" cy="120" r="96"></circle></svg>
            <div class="dial-center"><div id="se-time" class="dial-time">00:00.0</div><div class="dial-meta" id="se-meta">‚Äî</div></div>
          </div>
          <div class="row">
            <button id="se-start" class="btn circle green">D√©marrer</button>
            <button id="se-stop" class="btn circle amber">Stop</button>
            <button id="se-next" class="btn circle cyan">Suivant</button>
            <button id="se-reset" class="btn circle red">R√©init.</button>
          </div>
        </div>
      </div>
      <div class="card" style="margin-top:12px">
        <h3 style="margin:0 0 8px">QR S√©rie</h3>
        <div class="row">
          <div id="qrcode-series" class="card" style="border:1px dashed var(--ring); padding:8px"></div>
          <button id="se-qr" class="btn violet">QR S√©rie</button>
        </div>
      </div>
    </div>
  </div>
</section>

<footer>ChronoVitesse - Equipe EPS Lyc√©e Vauban - LUXEMBOURG - JB</footer>

<script>
/* ---------- NAV & UTILS ---------- */
const nav = id => { document.querySelectorAll('.section').forEach(s=>s.classList.remove('active')); document.getElementById(id).classList.add('active'); };
document.getElementById('go-modes').onclick=()=>nav('modes');

const fmt = (ms)=>{ const t=Math.floor(ms/100)/10, m=Math.floor(t/60), s=Math.floor(t%60), d=Math.floor((t*10)%10); return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}.${d}`; };
function dial(circle,wrap,ratio,alert=false){
  const r = parseFloat(circle.getAttribute('r')), C = 2*Math.PI*r;
  circle.style.strokeDasharray = `${C} ${C}`;
  circle.style.strokeDashoffset = String(C*(1-Math.max(0,Math.min(1,ratio))));
  wrap.classList.toggle('alert', alert);
}

/* ---------- CHRONO AVEC TOURS ---------- */
const L = {
  student:{nom:'',prenom:'',classe:'',sexe:'M'},
  total:800, lap:200, running:false, startAt:0, lastLapAt:0, tickId:null, mode:'lap', laps:[]
};
document.getElementById('to-race').onclick=()=>{
  L.student.nom = document.getElementById('in-nom').value.trim();
  L.student.prenom = document.getElementById('in-prenom').value.trim();
  L.student.classe = document.getElementById('in-classe').value.trim();
  L.student.sexe = document.getElementById('in-sexe').value || 'M';
  L.total = +document.getElementById('in-total').value||0;
  L.lap   = +document.getElementById('in-lap').value||1;
  if(!L.student.nom || !L.student.prenom || !L.student.classe){ alert('Nom/Pr√©nom/Classe requis.'); return; }
  document.getElementById('race-student').textContent = `${L.student.prenom} ${L.student.nom} ‚Äî ${L.student.classe}`;
  document.getElementById('meta-total').textContent = String(L.total);
  document.getElementById('meta-done').textContent = '0';
  document.getElementById('laps-body').innerHTML='';
  document.getElementById('qrcode').innerHTML='';
  L.laps=[]; L.running=false; L.startAt=0; L.lastLapAt=0; clearInterval(L.tickId); L.tickId=null;
  document.getElementById('timer-laps').textContent='00:00.0';
  dial(document.getElementById('dial-progress-laps'), document.getElementById('dial-wrap-laps'),0,false);
  nav('race');
};
document.getElementById('mode-tours').onchange=e=>L.mode=e.target.value;
const doneMeters=()=>L.laps.length*L.lap;
function updLapsUI(){
  const elapsed = performance.now()-L.startAt;
  document.getElementById('timer-laps').textContent=fmt(elapsed);
  const ratio = L.total>0 ? doneMeters()/L.total : 0;
  const alert = (Math.floor((elapsed/1000)%60)>=50);
  dial(document.getElementById('dial-progress-laps'), document.getElementById('dial-wrap-laps'), ratio, alert);
}
document.getElementById('start-laps').onclick=()=>{
  if(L.running) return; L.running=true; const now=performance.now(); L.startAt=now; L.lastLapAt=now; L.tickId=setInterval(updLapsUI,100);
};
document.getElementById('stop-laps').onclick=()=>{ if(!L.running) return; L.running=false; clearInterval(L.tickId); L.tickId=null; updLapsUI(); };
document.getElementById('reset-laps').onclick=()=>{
  L.running=false; clearInterval(L.tickId); L.tickId=null; L.laps=[]; document.getElementById('laps-body').innerHTML='';
  document.getElementById('timer-laps').textContent='00:00.0'; document.getElementById('qrcode').innerHTML=''; document.getElementById('meta-done').textContent='0';
  dial(document.getElementById('dial-progress-laps'), document.getElementById('dial-wrap-laps'),0,false);
};
document.getElementById('new-laps').onclick=()=>nav('form');
document.getElementById('lap').onclick=()=>{
  if(!L.running) return;
  const now=performance.now(); const cum=now-L.startAt;
  const lapMs = (L.mode==='lap') ? (now-L.lastLapAt) : (cum - (L.laps.length?L.laps[L.laps.length-1].cumMs:0));
  L.lastLapAt=now;
  const vInst = L.lap>0 ? (L.lap/(lapMs/1000))*3.6 : 0;
  const idx=L.laps.length+1; const dist=idx*L.lap;
  L.laps.push({i:idx,dist,lapMs,cumMs:cum,vInst});
  const tr=document.createElement('tr');
  tr.innerHTML=`<td>${idx}</td><td>${dist}</td><td>${fmt(lapMs)}</td><td>${fmt(cum)}</td><td>${vInst.toFixed(2)}</td>`;
  document.getElementById('laps-body').appendChild(tr);
  document.getElementById('meta-done').textContent=String(doneMeters());
  dial(document.getElementById('dial-progress-laps'), document.getElementById('dial-wrap-laps'), (L.total?doneMeters()/L.total:0), false);
  if(doneMeters()>=L.total){ document.getElementById('stop-laps').click(); }
};
/* QR laps: nom, prenom, classe, temps_total, intermediaires[] */
function qrDataLaps(){
  const totalMs = L.laps.length? L.laps[L.laps.length-1].cumMs : 0;
  const payload=[{ nom:L.student.nom, prenom:L.student.prenom, classe:L.student.classe, temps_total:fmt(totalMs), intermediaires: L.laps.map(x=>fmt(x.lapMs)) }];
  return JSON.stringify(payload);
}
document.getElementById('qr-laps').onclick=()=>{
  if(!L.laps.length){ alert('Ajoute au moins un tour.'); return; }
  const box=document.getElementById('qrcode'); box.innerHTML='';
  new QRCode(box,{text:qrDataLaps(), width:256, height:256, correctLevel:QRCode.CorrectLevel.M});
};
/* CSV laps */
function download(name,text){ const blob=new Blob([text],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download=name;document.body.appendChild(a);a.click();a.remove();URL.revokeObjectURL(url);}
document.getElementById('csv-laps-simple').onclick=()=>{
  if(!L.laps.length){ alert('Pas de donn√©es.'); return; }
  const totalMs=L.laps[L.laps.length-1].cumMs, inters=L.laps.map(x=>fmt(x.lapMs)).join(' | ');
  const headers=['nom','prenom','classe','sexe','temps_total','intermediaires'];
  const row=[L.student.nom,L.student.prenom,L.student.classe,(L.student.sexe==='Autre'?'M':L.student.sexe),fmt(totalMs),`"${inters}"`];
  download(`chronovitesse_${L.student.nom}_${L.student.prenom}_simple.csv`, headers.join(',')+'\n'+row.join(','));
};
document.getElementById('csv-laps-detail').onclick=()=>{
  if(!L.laps.length){ alert('
