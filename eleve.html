<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<link rel="stylesheet" href="assets/styles.css?v=7">
<title>Élève • Chrono Vitesse EPS</title>
</head>
<body onload="baseInit()">
<div class="container">
  <div class="header">
    <div class="brand"><img src="assets/icons/logo.svg" alt="logo">Espace élève</div>
    <div class="nav">
      <button onclick="toggleXL()">Taille XL</button>
      <button onclick="toggleDark()">Mode sombre</button>
    </div>
  </div>

  <div class="card">
    <h2>Identité</h2>
    <div class="controls" role="group" aria-label="Identité">
      <label for="nom">Nom</label><input id="nom" placeholder="Nom" autocomplete="family-name">
      <label for="prenom">Prénom</label><input id="prenom" placeholder="Prénom" autocomplete="given-name">
      <label for="classe">Classe</label><input id="classe" placeholder="2A, 3C...">
      <label for="sexe">Sexe</label>
      <select id="sexe"><option value="">choisir</option><option value="F">fille</option><option value="M">garcon</option><option value="X">autre</option></select>
    </div>
  </div>

  <div class="card">
    <h2>Réglages</h2>
    <div class="controls" role="group" aria-label="Paramètres de test">
      <label for="tourMeters">Longueur du tour (m)</label>
      <input id="tourMeters" type="number" min="10" step="1" inputmode="numeric" placeholder="ex: 200">
      <button class="ghost" data-preset="100">100</button>
      <button class="ghost" data-preset="200">200</button>
      <button class="ghost" data-preset="250">250</button>
      <button class="ghost" data-preset="400">400</button>
      <label style="margin-left:12px" for="targetVMA">Cible VMA (km/h)</label>
      <input id="targetVMA" type="number" min="1" step="0.1" inputmode="decimal" placeholder="ex: 12.5">
      <label style="margin-left:12px" for="thr2">Seuils (%, vert/orange)</label>
      <input id="thr2" type="number" min="0.5" step="0.5" inputmode="decimal" value="2">
      <input id="thr5" type="number" min="1" step="0.5" inputmode="decimal" value="5">
    </div>
  </div>

  <div class="card">
    <h2>Test</h2>
    <div class="controls" role="group" aria-label="Options appareil">
      <button class="ghost" id="toggleBeep" aria-pressed="false">Bip</button>
      <button class="ghost" id="toggleVib" aria-pressed="false">Vibration</button>
      <button class="ghost" id="toggleFS">Plein écran</button>
      <button class="ghost" id="toggleWake">Anti-veille</button>
    </div>

    <div class="timer zone" id="timerZone">
      <div class="timer-screen" id="screen" aria-live="polite">00:00</div>
      <div class="timer-sub" id="screenSub">millisecondes masquées</div>
      <div class="timer-bar" aria-hidden="true"><div id="barFill"></div></div>

      <div class="timer-actions">
        <button class="btn-start" id="btnStart">Démarrer</button>
        <button class="btn-lap" id="btnLap" disabled>Intermédiaire</button>
        <button class="btn-stop" id="btnStop" disabled>Stop</button>
        <button class="btn-reset" id="btnReset" disabled>Réinitialiser</button>
        <button class="ghost" id="btnShowMs">Voir ms (fin)</button>
        <button class="ghost" id="btnTest6">Test 6'</button>
        <button class="ghost" id="btnTest12">Test 12'</button>
      </div>

      <div class="timer-sub" id="liveVMA" aria-live="polite">Vitesse: — • VMA: — • Dist: 0 m</div>

      <table class="table" id="splitTable">
        <thead><tr><th>#</th><th>Passage</th><th>Temps au passage</th><th>Temps cumulé</th><th>Total</th></tr></thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <div class="card">
    <h2>Exporter</h2>
    <div class="controls">
      <button class="primary" id="btnCSV">Enregistrer CSV</button>
    </div>
  </div>

  <div class="footer">© EPS • Design PRO v7</div>
</div>

<script src="assets/app.js?v=7"></script>
<script>
// Persist champs
(function(){['tourMeters','targetVMA','thr2','thr5','nom','prenom','classe','sexe'].forEach(id=>{const el=document.getElementById(id);const v=localStorage.getItem('f_'+id);if(v!==null)el.value=v;el.addEventListener('input',()=>localStorage.setItem('f_'+id,el.value));});})();
// Device
let wl=null; toggleBeep.onclick=()=>{useBeep=!useBeep;toggleBeep.setAttribute('aria-pressed',useBeep)};
toggleVib.onclick=()=>{useVib=!useVib;toggleVib.setAttribute('aria-pressed',useVib)};
toggleFS.onclick=()=>{ if(!document.fullscreenElement){ document.documentElement.requestFullscreen?.(); } else { document.exitFullscreen?.(); } };
toggleWake.onclick=async()=>{ try{ wl = wl || (navigator.wakeLock && await navigator.wakeLock.request('screen')); }catch(e){ alert("Anti-veille non supporté"); } };

// Timer
const timer=new DigitalTimer({screen:screen, sub:screenSub, bar:barFill});
btnStart.onclick=()=>{timer.start(); btnLap.disabled=false; btnStop.disabled=false; btnReset.disabled=false;};
btnLap.onclick=()=>{ timer.lap(); vibrate(60); beep(); };
btnStop.onclick=()=>timer.stop();
btnReset.onclick=()=>{timer.reset(); document.querySelector('#splitTable tbody').innerHTML=''; liveVMA.textContent='Vitesse: — • VMA: — • Dist: 0 m'; nextLabelMeters = getTour(); setZone(null);};
btnShowMs.onclick=()=>{screenSub.textContent='Total (centièmes) : '+timer.fmt(timer.getTotal(),true);};
btnTest6.onclick=()=>timer.setTargetMinutes(6); btnTest12.onclick=()=>timer.setTargetMinutes(12);

function getTour(){ const v = parseInt((tourMeters.value||'').trim()||'200',10); return Math.max(10,v); }
document.querySelectorAll('[data-preset]').forEach(b=> b.onclick=()=>{ tourMeters.value=b.getAttribute('data-preset'); nextLabelMeters = getTour(); });

function getTargetVMA(){ const t = parseFloat(targetVMA.value||'0'); return t>0 ? t : null; }
function getThr(){ const t2= parseFloat(thr2.value||'2'); const t5= parseFloat(thr5.value||'5'); return {t2:Math.max(0.5,t2)/100, t5:Math.max(1,t5)/100}; }
function setZone(color){ const box = document.getElementById('timerZone'); box.classList.remove('green','orange','red'); if(!color) return; box.classList.add(color); }

let nextLabelMeters = getTour();
const tbody=document.querySelector('#splitTable tbody');
function addRow(row){const tr=document.createElement('tr'); const label=`${nextLabelMeters} m`; nextLabelMeters+=getTour();
  tr.innerHTML=`<td>${row.idx}</td><td>${label}</td><td>${timer.fmt(row.lapMs,false)}</td><td>${timer.fmt(row.cumMs,false)}</td><td class="total-cell">—</td>`; tbody.appendChild(tr);}
Bus.on('timer:lap',row=>{addRow(row); updateLive();});
Bus.on('timer:stop',info=>{[...tbody.querySelectorAll('.total-cell')].forEach(td=>td.textContent=timer.fmt(info.totalMs,false)); updateLive(true);});

function updateLive(final=false){
  const splits=timer.getSplits(); const dist=splits.length*getTour(); const sec=timer.getTotal()/1000;
  const vInst=splits.length?(getTour()/(splits[splits.length-1].lapMs/1000))*3.6:0;
  const vma=sec>0?(dist/sec)*3.6:0;
  liveVMA.textContent=`Vitesse: ${vInst.toFixed(2)} km/h • VMA: ${vma.toFixed(2)} km/h • Dist: ${dist} m`+(final?` • Total VMA: ${vma.toFixed(2)} km/h`:'' );
  const tgt = getTargetVMA(); if(tgt){ const {t2,t5}=getThr(); const dev = Math.abs(vInst - tgt) / tgt; setZone(dev<=t2 ? 'green' : (dev<=t5 ? 'orange' : 'red')); }
  requestAnimationFrame(()=>updateLive(false));
}
updateLive();

// CSV
btnCSV.onclick=()=>{
  const n=nom.value.trim(), p=prenom.value.trim(), c=classe.value.trim(), s=sexe.value;
  const splits=timer.getSplits(); const tour=getTour(); const total=timer.getTotal();
  const dist=splits.length*tour; const vma=total>0?(dist/(total/1000))*3.6:0; const thr=getThr();
  const headers=['nom','prenom','classe','sexe','vma','tour_m','target_vma','thr2','thr5','split_idx','split_lap','split_cum','total'];
  const rows=[];
  if(splits.length){
    splits.forEach((sp,i)=>rows.push([n,p,c,s,vma.toFixed(2),tour,(getTargetVMA()||''),thr.t2*100,thr.t5*100,i+1,timer.fmt(sp.lapMs,true),timer.fmt(sp.cumMs,true),timer.fmt(total,true)]));
  }else{
    rows.push([n,p,c,s,vma.toFixed(2),tour,(getTargetVMA()||''),thr.t2*100,thr.t5*100,'','','',timer.fmt(total,true)]);
  }
  download(`vma_${p||'eleve'}_${n||''}.csv`, [headers.join(','), ...rows.map(r=>r.join(','))].join('\n'), 'text/csv;charset=utf-8');
};
</script>
</body></html>
