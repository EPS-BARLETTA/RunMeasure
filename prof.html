<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Prof • Chrono Vitesse EPS</title>
<link rel="stylesheet" href="assets/styles.css">
<script defer src="assets/app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head><body onload="initDark()">
<div class="container">
  <div class="header"><div class="brand">Espace prof</div><div class="nav"><a href="index.html">Accueil</a><button onclick="toggleDark()">Mode sombre</button></div></div>

  <div class="card">
    <div class="controls">
      <label>Longueur du tour (m)</label>
      <input id="tourMeters" type="number" min="10" step="1" placeholder="ex: 187">
      <button class="btn-ghost" data-preset="100">100</button>
      <button class="btn-ghost" data-preset="200">200</button>
      <button class="btn-ghost" data-preset="250">250</button>
      <button class="btn-ghost" data-preset="400">400</button>
      <label style="margin-left:12px">Cible VMA (km/h)</label>
      <input id="targetVMA" type="number" min="1" step="0.1" placeholder="ex: 12.5">
    </div>
  </div>

  <div class="card">
    <div class="timer zone" id="timerZone">
      <div class="timer-screen" id="screen">00:00</div>
      <div class="timer-sub" id="screenSub">millisecondes masquées</div>
      <div class="timer-bar"><div id="barFill"></div></div>
      <div class="timer-actions">
        <button class="btn-start" id="btnStart">Démarrer</button>
        <button class="btn-lap" id="btnLap" disabled>Intermédiaire</button>
        <button class="btn-stop" id="btnStop" disabled>Stop</button>
        <button class="btn-reset" id="btnReset" disabled>Réinitialiser</button>
        <button class="btn-ghost" id="btnShowMs">Voir ms (fin)</button>
        <button class="btn-ghost" id="btnTest6">Test VMA 6'</button>
        <button class="btn-ghost" id="btnTest12">Test VMA 12'</button>
      </div>
      <div class="timer-sub" id="liveVMA">Vitesse: — • VMA: — • Dist: 0 m</div>
      <table class="table" id="splitTable"><thead><tr><th>#</th><th>Passage</th><th>Temps au passage</th><th>Temps cumulé</th><th>Total</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button class="btn-ghost" id="viewAlpha">A→Z</button>
      <button class="btn-ghost" id="viewVMAUp">VMA ↑</button>
      <button class="btn-ghost" id="viewVMADown">VMA ↓</button>
      <button class="btn-ghost" id="btnCSV">Exporter CSV</button>
      <button class="btn-ghost" id="btnPDF">PDF / Imprimer</button>
      <button class="btn-ghost" id="btnArchive">Archiver la classe</button>
    </div>
    <table class="table" id="tblEleves"><thead><tr><th>Nom</th><th>Prénom</th><th>Classe</th><th>Sexe</th><th>VMA (km/h)</th><th class="no-print">QR</th></tr></thead><tbody></tbody></table>

    <div class="card no-print" id="qrMount" style="display:none"></div>

    <div class="card">
      <details>
        <summary>Archives de classes</summary>
        <div id="archives"></div>
      </details>
    </div>
  </div>

  <div class="footer">© Équipe EPS • Vauban — LUXEMBOURG — JB</div>
</div>

<script>
// Dark init
initDark();

// Timer + zone
const timer=new DigitalTimer({screen:screen, sub:screenSub, bar:barFill});
function getTour(){ const v=parseInt(document.getElementById('tourMeters').value||'0',10); return v>0? v:200; }
function getTargetVMA(){ const t=parseFloat(document.getElementById('targetVMA').value||'0'); return t>0? t: null; }
function setZone(color){ const box=document.getElementById('timerZone'); box.classList.remove('green','orange','red'); if(!color) return; box.classList.add(color); }
document.querySelectorAll('[data-preset]').forEach(b=> b.onclick=()=>{ document.getElementById('tourMeters').value=b.getAttribute('data-preset'); nextLabelMeters = getTour(); });

btnStart.onclick=()=>{timer.start(); btnLap.disabled=false; btnStop.disabled=false; btnReset.disabled=false;};
btnLap.onclick=()=>timer.lap();
btnStop.onclick=()=>timer.stop();
btnReset.onclick=()=>{timer.reset(); document.querySelector('#splitTable tbody').innerHTML=''; liveVMA.textContent='Vitesse: — • VMA: — • Dist: 0 m'; nextLabelMeters = getTour(); setZone(null); };
btnShowMs.onclick=()=>{screenSub.textContent='Total (centièmes) : '+timer.fmt(timer.getTotal(),true);};
document.getElementById('btnTest6').onclick=()=>timer.setTargetMinutes(6);
document.getElementById('btnTest12').onclick=()=>timer.setTargetMinutes(12);

let nextLabelMeters = getTour();
const tbodySplits=document.querySelector('#splitTable tbody');
function addRow(row){const tr=document.createElement('tr'); const label=`${nextLabelMeters} m`; nextLabelMeters+=getTour();
  tr.innerHTML=`<td>${row.idx}</td><td>${label}</td><td>${timer.fmt(row.lapMs,false)}</td><td>${timer.fmt(row.cumMs,false)}</td><td class="total-cell">—</td>`; tbodySplits.appendChild(tr);}
Bus.on('timer:lap',row=>{addRow(row); updateLive();});
Bus.on('timer:stop',info=>{[...tbodySplits.querySelectorAll('.total-cell')].forEach(td=>td.textContent=timer.fmt(info.totalMs,false)); updateLive(true);});

function updateLive(final=false){
  const splits=timer.getSplits(); const dist=splits.length*getTour(); const sec=timer.getTotal()/1000;
  const vInst=splits.length?(getTour()/(splits[splits.length-1].lapMs/1000))*3.6:0;
  const vma=sec>0?(dist/sec)*3.6:0;
  liveVMA.textContent=`Vitesse: ${vInst.toFixed(2)} km/h • VMA: ${vma.toFixed(2)} km/h • Dist: ${dist} m`+(final?` • Total VMA: ${vma.toFixed(2)} km/h`:'' );
  const tgt=getTargetVMA(); if(tgt){ const dev=Math.abs(vInst-tgt)/tgt; setZone(dev<=0.02?'green':(dev<=0.05?'orange':'red')); }
}

// Élèves
let eleves=load('eleves',[]); let view='alpha'; const tbody=document.querySelector('#tblEleves tbody');
function render(){tbody.innerHTML=''; let list=eleves.slice();
  if(view==='alpha'){list.sort((a,b)=>(a.nom||'').localeCompare(b.nom||'')||(a.prenom||'').localeCompare(b.prenom||''));}
  if(view==='vmaUp'){list.sort((a,b)=>(a.vma??-1)-(b.vma??-1));}
  if(view==='vmaDown'){list.sort((a,b)=>(b.vma??-1)-(a.vma??-1));}
  list.forEach((e)=>{const tr=document.createElement('tr'); const vText=(e.vma?.toFixed?e.vma.toFixed(2):(e.vma||''));
    tr.innerHTML=`<td>${e.nom||''}</td><td>${e.prenom||''}</td><td>${e.classe||''}</td><td>${e.sexe||''}</td><td>${vText}</td>
      <td class="no-print"><button class="btn-ghost btn-sm">QR</button></td>`;
    tr.querySelector('button').onclick=()=>{
      const payload={nom:e.nom, prenom:e.prenom, classe:e.classe, sexe:e.sexe||'', vma:e.vma?+(+e.vma).toFixed(2):'', Nom:e.nom, "Prénom":e.prenom, Classe:e.classe, Sexe:e.sexe||'', VMA:e.vma?+(+e.vma).toFixed(2):''};
      const mount=document.getElementById('qrMount'); mount.style.display='block'; mount.innerHTML='';
      const box=document.createElement('div'); box.className='qr'; mount.appendChild(box);
      new QRCode(box,{text:JSON.stringify(payload),width:180,height:180});
    };
    tr.addEventListener('click', (ev)=>{
      if(ev.target.tagName==='BUTTON') return;
      const dist=timer.getSplits().length*getTour(); const vma=timer.getTotal()>0?(dist/(timer.getTotal()/1000))*3.6:0; e.vma=vma; store('eleves',eleves); render();
    });
    tbody.appendChild(tr);
  });
}
render();
viewAlpha.onclick=()=>{view='alpha'; render();};
viewVMAUp.onclick=()=>{view='vmaUp'; render();};
viewVMADown.onclick=()=>{view='vmaDown'; render();};

// Import CSV
csvIn?.addEventListener('change',ev=>{const file=ev.target.files[0]; if(!file) return; const reader=new FileReader(); reader.onload=e=>{
  const lines=e.target.result.trim().split(/\r?\n/); const head=lines.shift().split(',').map(s=>s.trim());
  eleves=lines.map(line=>{const cols=line.split(',').map(s=>s.trim()); const o={}; head.forEach((h,i)=>o[h]=cols[i]||''); return {nom:o.nom||o.Nom||'', prenom:o.prenom||o["Prénom"]||'', classe:o.classe||o.Classe||'', sexe:o.sexe||o.Sexe||'', vma:o.vma?+o.vma:(o.VMA?+o.VMA:'')}; });
  store('eleves',eleves); render();
}; reader.readAsText(file,'utf-8');});

// Save/Load/Clear
saveList.onclick=()=>store('eleves',eleves);
loadList.onclick=()=>{eleves=load('eleves',[]); render();};
clearList.onclick=()=>{eleves=[]; store('eleves',eleves); render();};

// Export CSV & PDF
function asCSV(list){const headers=['nom','prenom','classe','sexe','vma']; return [headers.join(','), ...list.map(e=>[e.nom||'',e.prenom||'',e.classe||'',e.sexe||'', (e.vma?.toFixed?e.vma.toFixed(2):(e.vma||''))].join(','))].join('\n');}
btnCSV.onclick=()=>{download('classe-vma.csv', asCSV(eleves), 'text/csv;charset=utf-8');};
btnPDF.onclick=()=>window.print();

// Archives
function loadArchives(){return JSON.parse(localStorage.getItem('archives')||'[]');}
function saveArchives(a){localStorage.setItem('archives', JSON.stringify(a));}
function renderArchives(){
  const mount=document.getElementById('archives'); mount.innerHTML=''; const archives=loadArchives(); if(!archives.length){mount.innerHTML='<p>Aucune archive pour le moment.</p>'; return;}
  archives.forEach((ar,i)=>{
    const box=document.createElement('div'); box.className='card';
    box.innerHTML=`<div style="display:flex;justify-content:space-between;align-items:center;gap:8px;flex-wrap:wrap">
      <strong>${ar.className||'Classe'}</strong> <span class="badge">${ar.timestamp}</span>
      <div class="controls no-print" style="margin-left:auto">
        <button class="btn-ghost" data-dl="${i}">CSV</button>
        <button class="btn-ghost" data-r="${i}">Restaurer</button>
        <button class="btn-ghost" data-x="${i}">Supprimer</button>
      </div></div>`;
    const table=document.createElement('table'); table.className='table'; table.innerHTML='<thead><tr><th>Nom</th><th>Prénom</th><th>Classe</th><th>Sexe</th><th>VMA</th></tr></thead>';
    const tb=document.createElement('tbody');
    ar.eleves.forEach(e=>{const tr=document.createElement('tr'); tr.innerHTML=`<td>${e.nom||''}</td><td>${e.prenom||''}</td><td>${e.classe||''}</td><td>${e.sexe||''}</td><td>${e.vma?.toFixed?e.vma.toFixed(2):(e.vma||'')}</td>`; tb.appendChild(tr);});
    table.appendChild(tb); box.appendChild(table); mount.appendChild(box);
    box.querySelector(`[data-dl="${i}"]`).onclick=()=>{download((ar.className||'classe')+'-'+ar.timestamp.replace(/[: ]/g,'_')+'.csv', asCSV(ar.eleves), 'text/csv;charset=utf-8');};
    box.querySelector(`[data-r="${i}"]`).onclick=()=>{eleves=ar.eleves.slice(); store('eleves',eleves); render();};
    box.querySelector(`[data-x="${i}"]`).onclick=()=>{const arr=loadArchives(); arr.splice(i,1); saveArchives(arr); renderArchives();};
  });
}
renderArchives();
btnArchive.onclick=()=>{
  if(!eleves.length){alert('Aucun élève à archiver.'); return;}
  const entry = { className: 'Classe', timestamp: nowISO(), eleves: eleves.slice() };
  const arr = loadArchives(); arr.push(entry); saveArchives(arr); alert('Classe archivée.'); renderArchives();
};
</script>
</body></html>
