<!DOCTYPE html>
<html lang="fr"><head>
<meta charset="utf-8"><meta name="viewport" content="width=device-width,initial-scale=1">
<title>Élève • Chrono Vitesse EPS</title>
<link rel="stylesheet" href="assets/styles.css">
<script defer src="assets/app.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
</head><body onload="initDark()">
<div class="container">
  <div class="header"><div class="brand">Espace élève</div><div class="nav"><a href="index.html">Accueil</a><button onclick="toggleDark()">Mode sombre</button></div></div>

  <div class="card">
    <div class="controls">
      <label>Longueur du tour (m)</label>
      <input id="tourMeters" type="number" min="10" step="1" placeholder="ex: 187">
      <button class="btn-ghost" data-preset="100">100</button>
      <button class="btn-ghost" data-preset="200">200</button>
      <button class="btn-ghost" data-preset="250">250</button>
      <button class="btn-ghost" data-preset="400">400</button>
      <label style="margin-left:12px">Cible VMA (km/h)</label>
      <input id="targetVMA" type="number" min="1" step="0.1" placeholder="ex: 12.5">
    </div>
  </div>

  <div class="card">
    <div class="timer zone" id="timerZone">
      <div class="timer-screen" id="screen">00:00</div>
      <div class="timer-sub" id="screenSub">millisecondes masquées</div>
      <div class="timer-bar"><div id="barFill"></div></div>
      <div class="timer-actions">
        <button class="btn-start" id="btnStart">Démarrer</button>
        <button class="btn-lap" id="btnLap" disabled>Intermédiaire</button>
        <button class="btn-stop" id="btnStop" disabled>Stop</button>
        <button class="btn-reset" id="btnReset" disabled>Réinitialiser</button>
        <button class="btn-ghost" id="btnShowMs">Voir ms (fin)</button>
        <button class="btn-ghost" id="btnTest6">Test VMA 6'</button>
        <button class="btn-ghost" id="btnTest12">Test VMA 12'</button>
      </div>
      <div class="timer-sub" id="liveVMA">Vitesse: — • VMA: — • Dist: 0 m</div>
      <table class="table" id="splitTable"><thead><tr><th>#</th><th>Passage</th><th>Temps au passage</th><th>Temps cumulé</th><th>Total (à l’arrêt)</th></tr></thead><tbody></tbody></table>
    </div>
  </div>

  <div class="card">
    <div class="controls">
      <button class="btn-ghost" id="btnQr">QR → ScanProf</button>
      <button class="btn-ghost" id="btnCSV">Enregistrer CSV</button>
    </div>
    <div class="no-print" id="qrcode" style="margin-top:12px;"></div>
  </div>

  <div class="footer">© Équipe EPS • Vauban — LUXEMBOURG — JB</div>
</div>

<script>
// Timer
const timer=new DigitalTimer({screen:screen, sub:screenSub, bar:barFill});
btnStart.onclick=()=>{timer.start(); btnLap.disabled=false; btnStop.disabled=false; btnReset.disabled=false;};
btnLap.onclick=()=>timer.lap();
btnStop.onclick=()=>timer.stop();
btnReset.onclick=()=>{timer.reset(); document.querySelector('#splitTable tbody').innerHTML=''; liveVMA.textContent='Vitesse: — • VMA: — • Dist: 0 m'; nextLabelMeters = getTour(); setZone(null);};
btnShowMs.onclick=()=>{screenSub.textContent='Total (centièmes) : '+timer.fmt(timer.getTotal(),true);};
document.getElementById('btnTest6').onclick=()=>timer.setTargetMinutes(6);
document.getElementById('btnTest12').onclick=()=>timer.setTargetMinutes(12);

function getTour(){ const v = parseInt(document.getElementById('tourMeters').value||'0',10); return (v>0? v:200); }
document.querySelectorAll('[data-preset]').forEach(b=> b.onclick=()=>{ document.getElementById('tourMeters').value=b.getAttribute('data-preset'); nextLabelMeters = getTour(); });

function getTargetVMA(){ const t = parseFloat(document.getElementById('targetVMA').value||'0'); return t>0 ? t : null; }
function setZone(color){ const box = document.getElementById('timerZone'); box.classList.remove('green','orange','red'); if(!color) return; box.classList.add(color); }

let nextLabelMeters = getTour();
const tbody=document.querySelector('#splitTable tbody');
function addRow(row){const tr=document.createElement('tr'); const label=`${nextLabelMeters} m`; nextLabelMeters+=getTour();
  tr.innerHTML=`<td>${row.idx}</td><td>${label}</td><td>${timer.fmt(row.lapMs,false)}</td><td>${timer.fmt(row.cumMs,false)}</td><td class="total-cell">—</td>`; tbody.appendChild(tr);}
Bus.on('timer:lap',row=>{addRow(row); updateLive();});
Bus.on('timer:stop',info=>{[...tbody.querySelectorAll('.total-cell')].forEach(td=>td.textContent=timer.fmt(info.totalMs,false)); updateLive(true);});

function updateLive(final=false){
  const splits=timer.getSplits(); const dist=splits.length*getTour(); const sec=timer.getTotal()/1000;
  const vInst=splits.length?(getTour()/(splits[splits.length-1].lapMs/1000))*3.6:0;
  const vma=sec>0?(dist/sec)*3.6:0;
  liveVMA.textContent=`Vitesse: ${vInst.toFixed(2)} km/h • VMA: ${vma.toFixed(2)} km/h • Dist: ${dist} m`+(final?` • Total VMA: ${vma.toFixed(2)} km/h`:'' );
  // Zones couleur: vert (±2%), orange (±5%), rouge sinon
  const tgt = getTargetVMA();
  if(tgt){ const dev = Math.abs(vInst - tgt) / tgt; setZone(dev<=0.02 ? 'green' : (dev<=0.05 ? 'orange' : 'red')); }
}

// QR ScanProf
function makeQrPayload(){
  const n=(document.getElementById('nom')||{value:''}).value?.trim()||'';
  const p=(document.getElementById('prenom')||{value:''}).value?.trim()||'';
  const c=(document.getElementById('classe')||{value:''}).value?.trim()||'';
  const s=(document.getElementById('sexe')||{value:''}).value||'';
  const splits=timer.getSplits(); const dist=splits.length*getTour();
  const vma=timer.getTotal()>0?(dist/(timer.getTotal()/1000))*3.6:0;
  return {nom:n, prenom:p, classe:c, sexe:s, vma:+vma.toFixed(2), Nom:n, "Prénom":p, Classe:c, Sexe:s, VMA:+vma.toFixed(2)};
}
btnQr.onclick=()=>{const txt=JSON.stringify(makeQrPayload()); qrcode.innerHTML=''; new QRCode(qrcode,{text:txt,width:180,height:180});};

// CSV local (iPad sans mail)
btnCSV.onclick=()=>{
  const payload = makeQrPayload();
  const headers = ['nom','prenom','classe','sexe','vma','tour_m','target_vma','split_idx','split_lap','split_cum','total'];
  const rows = [];
  const splits=timer.getSplits();
  const tour = getTour();
  const total = timer.getTotal();
  splits.forEach((s,i)=>{
    rows.push([payload.nom,payload.prenom,payload.classe,payload.sexe,payload.vma,tour,(getTargetVMA()||''), i+1, timer.fmt(s.lapMs,true), timer.fmt(s.cumMs,true), timer.fmt(total,true)]);
  });
  if(splits.length===0){
    rows.push([payload.nom,payload.prenom,payload.classe,payload.sexe,payload.vma,tour,(getTargetVMA()||''), '', '', '', timer.fmt(total,true)]);
  }
  const csv = [headers.join(','), ...rows.map(r=>r.join(','))].join('\n');
  download(`vma_${payload.prenom||'eleve'}_${payload.nom||''}.csv`, csv, 'text/csv;charset=utf-8');
};
</script>
</body></html>
