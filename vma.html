
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1">
  <title>VMA</title>
  <link rel="stylesheet" href="styles.css">
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
<header><h1>ğŸ§ª VMA</h1><a class="btn" href="menu.html">â¬…ï¸ Modes</a></header>
<main class="container">
  <section class="panel center"><div id="timer" class="timer">00:00.0</div></section>
  <section class="panel center">
    <div class="action-bar">
      <button id="start" class="btn btn-start btn-lg">DÃ©marrer</button>
      <button id="stop" class="btn btn-stop btn-lg" disabled>Stop</button>
      <button id="reset" class="btn btn-reset" disabled>RÃ©initialiser</button>
      <button id="openSettings" class="btn">âš™ï¸</button>
    </div>
  </section>
  <section id="qr" class="panel qr hidden"><h2>QR compatible ScanProf</h2><div id="qrBox" class="qr-box"></div></section>
</main>
<div class="footer">ChronoVitesse â€” Ã‰quipe EPS LycÃ©e Vauban â€” LUX â€” JB</div>

<div id="modal" class="modal">
  <div class="card">
    <h2>ParamÃ¨tres VMA</h2>
    <label>Type de test
      <select id="type">
        <option value="cooper">Cooper (12 min)</option>
        <option value="six">Demi-Cooper / Astrand (6 min)</option>
        <option value="leger">LÃ©ger-Boucher (palier)</option>
        <option value="vameval">VAMEVAL (palier)</option>
        <option value="libre">Libre (distance & durÃ©e)</option>
      </select>
    </label>
    <div class="grid two" id="freeFields">
      <label>Distance (m) <input id="distance" type="number" min="0"></label>
      <label>DurÃ©e (s) <input id="duree" type="number" min="0"></label>
    </div>
    <div class="grid two hidden" id="palierFields">
      <label>Palier <input id="palier" type="number" min="1"></label>
      <label>Navettes (option) <input id="navettes" type="number" min="0"></label>
    </div>
    <hr>
    <div class="row"><button class="btn cancel">Annuler</button><button class="btn btn-primary save">Enregistrer</button></div>
  </div>
</div>

<script src="common.js"></script>
<script>
const p=requireParams();
let t0=null,tick=null, cfg={type:'cooper', distance:0, duree:720, palier:0, navettes:0};
const timer=document.getElementById('timer');
function sync(){ freeFields.classList.toggle('hidden', cfg.type==='leger'||cfg.type==='vameval'); palierFields.classList.toggle('hidden', !(cfg.type==='leger'||cfg.type==='vameval')); }
bindModal('modal','openSettings',()=>{
  cfg.type=type.value; cfg.distance=Number(distance.value||0); cfg.duree=Number(duree.value|| (cfg.type==='cooper'?720:cfg.type==='six'?360:0));
  cfg.palier=Number(palier.value||0); cfg.navettes=Number(navettes.value||0); sync();
});
type.addEventListener('change',()=>{ if(type.value==='cooper') duree.value=720; else if(type.value==='six') duree.value=360; });
sync();
start.onclick=()=>{ t0=Date.now(); tick=setInterval(()=> timer.textContent=formatMs(Date.now()-t0), 100); start.disabled=true; stop.disabled=false; reset.disabled=true; };
stop.onclick=()=>{ clearInterval(tick); stop.disabled=true; reset.disabled=false;
  const duree_s = (cfg.type==='cooper'||cfg.type==='six') ? cfg.duree : Math.round((Date.now()-t0)/1000);
  let vma=0, dist=cfg.distance;
  if(cfg.type==='cooper'){ vma = +( (dist>0? dist : 0)*0.005 ).toFixed(2); }
  else if(cfg.type==='six'){ vma = +( (dist>0? dist : 0)*0.01 ).toFixed(2); }
  else if(cfg.type==='leger'){ vma = +(8.5 + 0.5*(Math.max(1,cfg.palier)-1)).toFixed(2); }
  else if(cfg.type==='vameval'){ vma = +(8.0 + 0.5*(Math.max(1,cfg.palier)-1)).toFixed(2); }
  else { vma = +( (cfg.distance>0 && cfg.duree>0) ? (cfg.distance/cfg.duree*3.6) : 0).toFixed(2); }
  const item=buildScanProfItem({ nom:p.nom, prenom:p.prenom, classe:p.classe, sexe:p.sexe, distance_m: dist, duree_s, vma_kmh:vma });
  showQR([item]);
};
reset.onclick=()=>{ clearInterval(tick); timer.textContent='00:00.0'; start.disabled=false; stop.disabled=true; reset.disabled=true; document.getElementById('qr').classList.add('hidden'); };
</script>
</body>
</html>
