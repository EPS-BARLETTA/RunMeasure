<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Chrono Intervalles EPS</title>

<!-- QRCode.js (fiable) -->
<script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>

<style>
  :root{ --bg:#0f172a; --panel:#111827; --ink:#e5e7eb; --muted:#94a3b8; --accent:#22c55e; --accent2:#3b82f6; --danger:#ef4444; --warn:#f59e0b; --card:#0b1220; }
  *{box-sizing:border-box} html,body{height:100%}
  body{ margin:0; background:linear-gradient(180deg, var(--bg), #0b1220 60%); color:var(--ink);
        font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Cantarell,"Noto Sans","Helvetica Neue",Arial;
        display:flex; min-height:100vh; flex-direction:column; }
  .page{ display:none; padding:18px; width:min(1100px,100%); margin:0 auto 24px; } .page.active{ display:block }

  /* Accueil */
  .hero{ display:flex; align-items:center; justify-content:center; min-height:70vh; text-align:center; padding:24px; }
  .hero h1{ margin:0 0 10px; font-weight:900; letter-spacing:.6px; font-size:clamp(2rem,6vw,3rem) }
  .hero p{ margin:0 0 20px; color:var(--muted); font-size:clamp(1rem,2.4vw,1.2rem) }

  /* Boutons */
  .btns{ display:flex; flex-wrap:wrap; gap:12px; justify-content:center }
  button{
    border:none; border-radius:14px; padding:14px 20px; font-weight:800; letter-spacing:.3px;
    background:#1f2a3a; color:var(--ink); cursor:pointer; font-size:1rem; min-width:180px;
    display:inline-flex; align-items:center; justify-content:center
  }
  button:active{ transform:translateY(1px) }
  .b-primary{background:var(--accent2)} .b-go{background:var(--accent)}
  .b-stop{background:var(--danger)} .b-lap{background:var(--warn)} .b-ghost{background:#0a1220;border:1px solid #223146}

  /* Titres / cartes */
  .title{ text-align:center; font-weight:800 }
  .title h2{ margin:.2rem 0 .1rem; font-size:clamp(1.2rem,2vw+.8rem,2rem) }
  .title p{ margin:0; color:var(--muted); font-size:.95rem }

  .grid{ display:grid; grid-template-columns:1.15fr .85fr; gap:16px }
  @media(max-width:860px){ .grid{ grid-template-columns:1fr } }

  .card{
    background:linear-gradient(180deg, var(--panel), var(--card));
    border:1px solid #1e293b; border-radius:18px; padding:16px;
    box-shadow:0 8px 30px rgba(0,0,0,.25);
  }
  .section-title{ font-weight:700; margin:0 0 8px; color:#cbd5e1 }
  .row{ display:flex; gap:12px; flex-wrap:wrap } .field{ flex:1 1 180px; min-width:180px }
  label{ display:block; font-size:.85rem; color:var(--muted); margin:0 0 6px }
  input[type="text"],input[type="number"],select{
    width:100%; padding:12px 14px; border-radius:12px; border:1px solid #243244;
    background:#0a1220; color:#e5e7eb; font-size:1rem; outline:none
  }

  /* Chrono */
  .chrono{
    display:flex; align-items:center; justify-content:center; text-align:center; font-variant-numeric:tabular-nums;
    background:radial-gradient(60% 60% at 50% 45%, #0b1730 0%, #0a1220 100%);
    border-radius:20px; border:1px solid #1f2a3a; padding:22px; margin-top:8px
  }
  .chrono-time{ font-size:clamp(2.6rem,7vw,4.8rem); font-weight:900; text-shadow:0 0 24px rgba(59,130,246,.25) }
  .badge{ display:inline-block; font-weight:800; padding:6px 10px; border-radius:999px; background:#0a1220; border:1px solid #223146; margin-right:8px }
  .meta{ text-align:center; color:#cbd5e1; margin:4px 0 10px }
  .hint{ color:var(--muted); font-size:.85rem; margin-top:6px; text-align:center }

  /* Tableau */
  table{ width:100%; border-collapse:separate; border-spacing:0; margin-top:10px; overflow:hidden; border-radius:14px; border:1px solid #223146 }
  thead th{ text-align:left; padding:12px 10px; font-size:.9rem; color:#cbd5e1; background:#0d1626; position:sticky; top:0 }
  tbody td{ padding:10px; border-top:1px solid #1c2940 } tbody tr:nth-child(odd){ background:#0a1422 } tbody tr:nth-child(even){ background:#0c1626 }

  /* Fiche s√©curit√© visuelle */
  .safe-grid{ display:grid; grid-template-columns:1fr 1fr; gap:14px }
  @media(max-width:860px){ .safe-grid{ grid-template-columns:1fr } }
  .safe{ border-radius:16px; padding:14px; border:1px solid rgba(255,255,255,.08); box-shadow:0 10px 30px rgba(0,0,0,.25) }
  .safe h3{ margin:0 0 6px; font-size:1.05rem } .safe ul{ margin:.3rem 0 0 1rem }
  .s1{ background:linear-gradient(135deg,#0b1220 0%,rgba(14,165,233,.15)100%) }
  .s2{ background:linear-gradient(135deg,#0b1220 0%,rgba(34,197,94,.15)100%) }
  .s3{ background:linear-gradient(135deg,#0b1220 0%,rgba(245,158,11,.18)100%) }
  .s4{ background:linear-gradient(135deg,#0b1220 0%,rgba(239,68,68,.18)100%) }

  /* QR */
  .qr-wrap{ display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap; justify-content:center; margin-top:12px }
  .qr-col{ text-align:center }
  .qr-title{ color:#cbd5e1; font-weight:800; margin:6px 0 8px }
  #qr-scanprof canvas,#qr-cumules canvas{
    background:#fff; padding:12px; border:1px solid #d1d5db; border-radius:10px;
  }

  footer{ margin-top:auto; background:#e5e7eb; color:#111827; text-align:center; padding:10px 12px; font-weight:700; border-top:1px solid #cbd5e1; }
</style>
</head>
<body>

<!-- ACCUEIL -->
<main id="page-home" class="page active">
  <div class="hero">
    <div>
      <h1>Chrono Intervalles EPS</h1>
      <p>Chronom√®tre avec temps interm√©diaires configurables, tableau r√©capitulatif et QR JSON.</p>
      <div class="btns">
        <button class="b-go" onclick="goTo('page-app')">D√©marrer</button>
        <button class="b-ghost" onclick="goTo('page-safety')">Fiche s√©curit√©</button>
      </div>
    </div>
  </div>
</main>

<!-- S√âCURIT√â (visuelle) -->
<section id="page-safety" class="page">
  <div class="title">
    <h2>Fiche s√©curit√© ‚Äì Demi-fond & gestes en cas de blessure</h2>
    <p>Si douleur vive ou malaise : <b>tu t‚Äôarr√™tes</b> et tu pr√©viens imm√©diatement.</p>
  </div>
  <div class="safe-grid">
    <div class="safe s1"><h3>üü¶ √âchauffement (10‚Äì15 min)</h3><ul><li>Course l√©g√®re + mobilit√©.</li><li>Mont√©es de genoux / talons-fesses.</li><li>2‚Äì3 lignes droites progressives.</li></ul></div>
    <div class="safe s2"><h3>üü© Hydratation & tenue</h3><ul><li>Petites gorg√©es r√©guli√®res.</li><li>Chaussures adapt√©es, lacets serr√©s.</li></ul></div>
    <div class="safe s3"><h3>üü® Pacing</h3><ul><li>Partir r√©gulier, pas trop vite.</li><li>Respiration rythm√©e, √©paules rel√¢ch√©es.</li></ul></div>
    <div class="safe s1"><h3>üü¶ Signaux d‚Äôalerte</h3><ul><li>Douleur vive, vertiges, essoufflement inhabituel ‚Üí <b>STOP</b>.</li></ul></div>
    <div class="safe s2"><h3>üü© Crampes / point de c√¥t√©</h3><ul><li>Ralentir, respirer, √©tirer doucement.</li></ul></div>
    <div class="safe s4"><h3>üü• Chute / entorse (R-I-C-E)</h3><ul><li>Repos, glace prot√©g√©e, compression, √©l√©vation.</li><li>Immobiliser si suspicion de fracture.</li></ul></div>
    <div class="safe s4"><h3>üü• Malaise grave</h3><ul><li>Allonger/asseoir, surveiller, alerter.</li><li>Appel d‚Äôurgence : <b>112</b>.</li></ul></div>
    <div class="safe s3"><h3>üü® Apr√®s l‚Äôeffort</h3><ul><li>Retour au calme + hydratation.</li><li>√âtirements doux.</li></ul></div>
  </div>
  <div class="btns" style="margin-top:10px">
    <button class="b-ghost" onclick="goTo('page-home')">‚Üê Accueil</button>
    <button class="b-go" onclick="goTo('page-app')">D√©marrer</button>
  </div>
</section>

<!-- R√âGLAGES -->
<section id="page-app" class="page">
  <div class="title">
    <h2>Chrono Intervalles</h2>
    <p>Renseigne l‚Äô√©l√®ve et les param√®tres, puis <b>D√©marrer</b>.</p>
  </div>
  <div class="btns" style="margin-bottom:8px">
    <button class="b-ghost" onclick="goTo('page-home')">Accueil</button>
    <button class="b-ghost" onclick="goTo('page-safety')">Fiche s√©curit√©</button>
  </div>

  <div class="grid">
    <section class="card">
      <h3 class="section-title">√âl√®ve</h3>
      <div class="row">
        <div class="field"><label>Nom</label><input id="nom" type="text" placeholder="Ex. Martin"></div>
        <div class="field"><label>Pr√©nom</label><input id="prenom" type="text" placeholder="Ex. Julie"></div>
        <div class="field"><label>Classe</label><input id="classe" type="text" placeholder="Ex. 4C"></div>
        <div class="field">
          <label>Sexe</label>
          <select id="sexe">
            <option value="" selected>Choisir‚Ä¶</option>
            <option value="F">Fille</option>
            <option value="M">Gar√ßon</option>
            <option value="A">Autre</option>
          </select>
        </div>
      </div>
    </section>

    <section class="card">
      <h3 class="section-title">Param√®tres de la course</h3>
      <div class="row">
        <div class="field"><label>Distance totale (m)</label><input id="distTot" type="number" inputmode="numeric" value="800" min="50" step="50"></div>
        <div class="field"><label>Palier / Temps interm√©diaire (m)</label><input id="distPalier" type="number" inputmode="numeric" value="200" min="25" step="25"></div>
        <div class="field"><label>&nbsp;</label><button id="apply" class="b-ghost">Appliquer / R√©initialiser param√®tres</button></div>
      </div>
      <p class="hint">La distance totale doit √™tre un multiple du palier (ex. 800 et 200).</p>
    </section>
  </div>

  <div class="btns" style="margin-top:10px">
    <button id="startFromSetup" class="b-go">D√©marrer la course</button>
  </div>
</section>

<!-- COURSE -->
<section id="page-run" class="page">
  <div class="meta" id="runMeta"></div>

  <section class="card">
    <div class="chrono">
      <div style="width:100%;text-align:center">
        <div class="chrono-time" id="time">00:00.00</div>
        <div class="btns" style="justify-content:center;margin-top:12px">
          <button id="start" class="b-go">D√©marrer</button>
          <button id="lap" class="b-lap" disabled>Temps interm√©diaire</button>
          <button id="stop" class="b-stop" disabled>Stop</button>
          <button id="reset" class="b-ghost">R√©initialiser</button>
        </div>
        <div class="hint">
          Palier: <b id="palierInfo">200 m</b> ¬∑ Cible: <b id="cibleInfo">800 m (4 paliers)</b> ¬∑ Progression: <b id="progInfo">0 / 4</b>
        </div>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:16px">
    <h3 class="section-title">R√©capitulatif des interm√©diaires</h3>
    <table>
      <thead><tr><th>Palier (m)</th><th>Temps sur le palier</th><th>Temps cumul√©</th><th>Vitesse sur le palier (km/h)</th></tr></thead>
      <tbody id="tbody"></tbody>
    </table>
  </section>

  <section class="card" style="margin-top:16px">
    <h3 class="section-title">QR & Export</h3>
    <div class="btns" style="justify-content:center">
      <button id="exportCSV" class="b-ghost" disabled>Exporter CSV</button>
    </div>

    <div class="qr-wrap">
      <div class="qr-col">
        <div class="qr-title">QR ScanProf (prof)</div>
        <div id="qr-scanprof"></div>
      </div>
      <div class="qr-col">
        <div class="qr-title">QR Cumul√©s (EPS)</div>
        <div id="qr-cumules"></div>
      </div>
    </div>
    <p class="hint">Les deux QR s‚Äôaffichent automatiquement √† la fin de la course (noir sur blanc).</p>
  </section>

  <div class="btns" style="margin-top:6px">
    <button class="b-ghost" onclick="goTo('page-app')">‚Üê Retour aux r√©glages</button>
  </div>
</section>

<footer>
  ChronoIntrervalles - Equipe EPS Lyc√©e Vauban - LUXEMBOURG -JB
</footer>

<script>
  // Navigation
  const goTo = id => { document.querySelectorAll('.page').forEach(p=>p.classList.remove('active')); document.getElementById(id).classList.add('active'); window.scrollTo({top:0,behavior:'smooth'}); };

  // Utils
  const $=(s,r=document)=>r.querySelector(s);
  const fmtTime=ms=>{const cs=Math.floor(ms/10)%100,s=Math.floor(ms/1000)%60,m=Math.floor(ms/60000);const pad=x=>String(x).padStart(2,'0');return `${pad(m)}:${pad(s)}.${pad(cs)}`;}
  const kmh=(m,ms)=>ms<=0?0:+((m/(ms/1000))*3.6).toFixed(2);
  const toast=m=>{const n=document.createElement('div');n.textContent=m;Object.assign(n.style,{position:'fixed',bottom:'16px',left:'50%',transform:'translateX(-50%)',background:'#111827',border:'1px solid #223146',color:'#e5e7eb',padding:'10px 14px',borderRadius:'10px',boxShadow:'0 10px 30px rgba(0,0,0,.35)',zIndex:50});document.body.appendChild(n);setTimeout(()=>n.remove(),2000);};

  // Elements
  const timeEl=$('#time'), palierInfo=$('#palierInfo'), cibleInfo=$('#cibleInfo'), progInfo=$('#progInfo'), tbody=$('#tbody'), runMeta=$('#runMeta');
  const nom=$('#nom'), prenom=$('#prenom'), classe=$('#classe'), sexe=$('#sexe');
  const distTotEl=$('#distTot'), distPalierEl=$('#distPalier'), btnApply=$('#apply');
  const btnStartSetup=$('#startFromSetup');
  const btnStart=$('#start'), btnLap=$('#lap'), btnStop=$('#stop'), btnReset=$('#reset');
  const btnExportCSV=$('#exportCSV'); const qrProf=$('#qr-scanprof'); const qrCum=$('#qr-cumules');

  // State
  let running=false, startTime=0, lastLapTime=0, rafId=0;
  let distTot=800, distPalier=200, nbPaliers=4, paliersDone=0;
  const splits=[]; // { palier, lapMs, cumMs, vKmh }
  let student={nom:'', prenom:'', classe:'', sexe:''};

  // Params
  function applyParams(){
    const t=parseInt(distTotEl.value,10), p=parseInt(distPalierEl.value,10);
    if(!Number.isFinite(t)||!Number.isFinite(p)||t<=0||p<=0){ toast('Distances invalides.'); return; }
    if(t%p!==0){ toast('‚ö†Ô∏è Distance totale multiple du palier requise.'); return; }
    distTot=t; distPalier=p; nbPaliers=distTot/distPalier;
    palierInfo.textContent=`${distPalier} m`; cibleInfo.textContent=`${distTot} m (${nbPaliers} paliers)`; progInfo.textContent=`0 / ${nbPaliers}`;
    hardReset(false);
  }
  btnApply.addEventListener('click', applyParams);

  // From setup ‚Üí run
  btnStartSetup.addEventListener('click', ()=>{
    if(!(nom.value.trim() && prenom.value.trim() && classe.value.trim() && sexe.value.trim())){
      toast('Renseigne Nom / Pr√©nom / Classe / Sexe.'); return;
    }
    applyParams();
    student={ nom:nom.value.trim(), prenom:prenom.value.trim(), classe:classe.value.trim(), sexe:sexe.value.trim() };
    runMeta.innerHTML=`<span class="badge">${student.prenom} ${student.nom}</span> ¬∑ Classe <b>${student.classe}</b> ¬∑ Palier <b>${distPalier} m</b> ¬∑ Cible <b>${distTot} m</b>`;
    goTo('page-run');
  });

  // Chrono
  function tick(){ const now=performance.now(); timeEl.textContent=fmtTime(now-startTime); rafId=requestAnimationFrame(tick); }

  btnStart.addEventListener('click',()=>{
    if(running) return;
    if(splits.length>0){ toast('R√©initialise pour un nouveau d√©part.'); return; }
    running=true; startTime=performance.now(); lastLapTime=0; paliersDone=0;
    progInfo.textContent=`${paliersDone} / ${nbPaliers}`;
    btnLap.disabled=false; btnStop.disabled=false; btnStart.disabled=true;
    btnExportCSV.disabled=true; qrProf.innerHTML=''; qrCum.innerHTML='';
    rafId=requestAnimationFrame(tick);
  });

  btnLap.addEventListener('click',()=>{
    if(!running) return;
    const now=performance.now(), cumMs=now-startTime, lapMs=cumMs-lastLapTime; lastLapTime=cumMs;
    paliersDone++; const pal=Math.min(distPalier*paliersDone,distTot); const v=kmh(distPalier,lapMs);
    splits.push({palier:pal, lapMs, cumMs, vKmh:v});
    const tr=document.createElement('tr'); tr.innerHTML=`<td>${pal}</td><td>${fmtTime(lapMs)}</td><td>${fmtTime(cumMs)}</td><td>${v.toFixed(2)}</td>`; tbody.appendChild(tr);
    progInfo.textContent=`${paliersDone} / ${nbPaliers}`;
    if(paliersDone>=nbPaliers){ stopRun(); }
  });

  btnStop.addEventListener('click',()=>stopRun(true));

  function stopRun(){
    if(!running) return;
    running=false; cancelAnimationFrame(rafId); rafId=0;
    btnLap.disabled=true; btnStop.disabled=true; btnStart.disabled=true; btnExportCSV.disabled=false;

    // G√©n√®re les 2 QR
    renderQR('qr-scanprof', buildScanProfPayload());
    renderQR('qr-cumules',  buildCumulesPayload());

    setTimeout(()=>qrProf.scrollIntoView({behavior:'smooth',block:'start'}),50);
  }

  btnReset.addEventListener('click',()=>hardReset(true));
  function hardReset(announce=true){
    running=false; cancelAnimationFrame(rafId); rafId=0; timeEl.textContent='00:00.00';
    lastLapTime=0; startTime=0; paliersDone=0; splits.length=0; tbody.innerHTML='';
    progInfo.textContent=`0 / ${nbPaliers}`; btnStart.disabled=false; btnLap.disabled=true; btnStop.disabled=true; btnExportCSV.disabled=true; qrProf.innerHTML=''; qrCum.innerHTML='';
    if(announce) toast('Param√®tres/r√©sultats r√©initialis√©s.');
  }

  // ====== QR PAYLOADS ======

  // ScanProf strict : [ { nom, prenom, classe, sexe(M/F), distance, vitesse, vma } ]
  function buildScanProfPayload(){
    const totalMs = splits.length ? splits[splits.length-1].cumMs : 0;
    const distance = distPalier * splits.length; // m parcourus
    const vitesse = totalMs>0 ? +(((distance)/(totalMs/1000))*3.6).toFixed(2) : 0; // km/h
    const vma = vitesse; // √† d√©faut d'une VMA mesur√©e
    const sx = (student.sexe==='M' || student.sexe==='F') ? student.sexe : 'F';

    return [{
      nom:     student.nom || "",
      prenom:  student.prenom || "",
      classe:  student.classe || "",
      sexe:    sx,
      distance: distance,
      vitesse:  vitesse,
      vma:      vma
    }];
  }

  // Cumul√©s EPS : [ { nom, prenom, classe, sexe, "200":"mm:ss.cs", "400":"mm:ss.cs", ... } ]
  function buildCumulesPayload(){
    const rec = {
      nom:     student.nom || "",
      prenom:  student.prenom || "",
      classe:  student.classe || "",
      sexe:    student.sexe || ""
    };
    splits.forEach((s,i)=>{
      const dist = distPalier*(i+1);
      rec[String(dist)] = fmtTime(s.cumMs);
    });
    return [rec];
  }

  // Rendu QR g√©n√©rique (noir sur blanc, correction √©lev√©e)
  function renderQR(targetId, payload){
    const el = document.getElementById(targetId);
    if(!el) return;
    el.innerHTML='';
    try{
      if(typeof QRCode==='undefined') throw new Error('QRCode.js non charg√©');
      new QRCode(el,{
        text: JSON.stringify(payload),
        width: 340,
        height: 340,
        colorDark : "#000000",
        colorLight: "#ffffff",
        correctLevel: QRCode.CorrectLevel.H
      });
    }catch(e){
      console.error(e);
      el.textContent='Erreur lors de la g√©n√©ration du QR.';
    }
  }

  // Export CSV
  function exportCSV(){
    if(!splits.length){ toast('Aucun temps √† exporter.'); return; }
    const headers=['Palier (m)','Temps palier','Temps cumul√©','Vitesse palier (km/h)'];
    const rows=splits.map(s=>[s.palier,fmtTime(s.lapMs),fmtTime(s.cumMs),s.vKmh.toFixed(2)]);
    const metaTop=[['Nom',student.nom],['Pr√©nom',student.prenom],['Classe',student.classe],['Sexe',student.sexe],['Distance cible (m)',distTot],['Palier (m)',distPalier]];
    const totalMs=splits[splits.length-1].cumMs; const doneDistance=paliersDone*distPalier; const vitesseMoy=kmh(doneDistance,totalMs);
    const metaBottom=[['Distance valid√©e (m)',doneDistance],['Temps total',fmtTime(totalMs)],['Vitesse moyenne (km/h)',vitesseMoy.toFixed(2)]];
    const toCSV=arr=>arr.map(r=>r.map(c=>`"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
    const csv=toCSV(metaTop)+'\n\n'+toCSV([headers])+'\n'+toCSV(rows)+'\n\n'+toCSV(metaBottom);
    const blob=new Blob([csv],{type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob);
    const fname=`${student.nom}_${student.prenom}_Intervalles.csv`.replace(/\s+/g,'_'); const a=document.createElement('a');
    a.href=url; a.download=fname; document.body.appendChild(a); a.click(); setTimeout(()=>{document.body.removeChild(a); URL.revokeObjectURL(url);},0);
  }
  $('#exportCSV').addEventListener('click', exportCSV);

  // Init
  function initLabels(){
    distTot=parseInt(distTotEl.value,10)||800; distPalier=parseInt(distPalierEl.value,10)||200; nbPaliers=distTot/distPalier;
    palierInfo.textContent=`${distPalier} m`; cibleInfo.textContent=`${distTot} m (${nbPaliers} paliers)`; progInfo.textContent=`0 / ${nbPaliers}`;
  }
  initLabels();
  goTo('page-home');
</script>
</body>
</html>
