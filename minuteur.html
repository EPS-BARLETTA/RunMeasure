
<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Minuteur • ChronoVitesse</title>
  <link rel="stylesheet" href="styles.css" />
  <script src="https://cdn.jsdelivr.net/npm/qrcodejs@1.0.0/qrcode.min.js"></script>
</head>
<body>
  <header class="app-header">
    <h1>⏳ Minuteur</h1>
    <div class="header-actions"><a class="btn" href="menu.html">⬅️ Modes</a> <a class="btn" href="aide.html">❓ Aide</a></div>
  </header>

  <main class="container">
    <section class="panel center">
      <div class="timer timer-min" id="timer">06:00</div>
    </section>

    <section class="panel compact">
      <h2>Réglage</h2>
      <div class="grid two">
        <label>Durée (minutes) <input id="mins" type="number" min="1" step="1" value="6" /></label>
        <label>Longueur d’un tour (m) <input id="tourLen" type="number" min="0" step="1" /></label>
      </div>
    </section>

    <section class="panel">
      <h2>Distance</h2>
      <div class="lap-bar">
        <button id="addLap" class="btn btn-primary">+1 tour</button>
        <button id="add14" class="btn">+¼</button>
        <button id="add12" class="btn">+½</button>
        <button id="add34" class="btn">+¾</button>
        <button id="minus10" class="btn">−10 m</button>
        <button id="plus10" class="btn">+10 m</button>
        <input id="manualAdjust" type="number" step="1" placeholder="+/− m">
        <button id="applyAdjust" class="btn">OK</button>
        <button id="undoLap" class="btn btn-reset">Annuler</button>
      </div>
      <div class="small">Tours: <span id="lapsCount">0</span> • Distance: <strong id="distTotal">0</strong> m</div>
    </section>

    <section class="panel">
      <div class="controls center">
        <button id="start" class="btn btn-start btn-large">Démarrer</button>
        <button id="stop" class="btn btn-stop btn-large" disabled>Stop</button>
        <button id="reset" class="btn btn-reset" disabled>Réinitialiser</button>
      </div>
    </section>

    <section id="qrZone" class="panel qr-zone hidden">
      <h2>QR compatible ScanProf</h2>
      <div id="qrGrid" class="qr-grid"></div>
    </section>
  </main>

  <footer class="footer">
    ChronoVitesse — Équipe EPS Lycée Vauban — LUXEMBOURG — JB
  </footer>

  <script src="common.js"></script>
  <script>
    const p = requireParams();
    if(p){ tourLen.value = p.tourLen||0; mins.value = p.minuteurMin||6; dist.tourLen = p.tourLen||0; }
    bindDistanceUI(document);

    let t0=null, tick=null, targetMs=0;
    const el = document.getElementById('timer');

    function render(){
      const elapsed = Date.now()-t0;
      const remain = Math.max(0, targetMs - elapsed);
      el.textContent = formatMin(remain);
      if (remain<=0){ finish(); }
    }
    function finish(){
      clearInterval(tick);
      stop.disabled = true; reset.disabled = false;
      const duree_s = Math.round(targetMs/1000);
      const item = buildScanProfItem({ nom:p.nom, prenom:p.prenom, classe:p.classe, sexe:p.sexe,
        distance_m:dist.total, duree_s, vma_kmh:vmaFromDistanceTime(dist.total, duree_s) });
      renderQRArray([item]);
    }
    start.onclick=()=>{ const minsV = Math.max(1, Number(mins.value||6)); targetMs = minsV*60*1000; t0=Date.now(); tick=setInterval(render,200);
      start.disabled=true; stop.disabled=false; reset.disabled=true; };
    stop.onclick=finish;
    reset.onclick=()=>{ clearInterval(tick); el.textContent=formatMin((Math.max(1, Number(mins.value||6)))*60*1000);
      start.disabled=false; stop.disabled=true; reset.disabled=true; dist.history=[]; updateDistUI(); document.getElementById('qrZone').classList.add('hidden'); };
  </script>
</body>
</html>
